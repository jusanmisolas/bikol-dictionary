<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Bikol Dictionary</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --primary:#0D1B2A;
  --secondary:#4B5563;
  --ink:#1F2937;
  --paper:#F8F9FA;
  --panel:#FFFFFF;
  --accent:#001F3D;
  --accent-soft:#5B6F8E;
  --gold-dark:#E3C45A;
  --hover:#F1F3F5;
  --rule:#E6E8EB;
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:"IBM Plex Sans",sans-serif;
  background:var(--paper);
  color:var(--ink);
  line-height:1.6;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}

header{
  background:var(--accent);
  color:#fff;
  min-height:64px; /* match search box height */
  padding:0 5vw; /* remove vertical padding */
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  z-index:1000;
}
.header-left{display:flex;align-items:center;gap:12px;}
header h1{font-size:18px;margin:0;}
.site-title{
  color:#fff;
  text-decoration:none;
  font-weight:600;
}
.site-title:hover{
  text-decoration:none; /* keep title clean on hover */
}

.header-right{display:flex;align-items:center;gap:10px;}


.header-btn{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.6);
  background:transparent;
  color:#fff;
  font-size:13px;
  font-weight:500;
  cursor:pointer;
}
.header-btn:hover{background:rgba(255,255,255,.12);} 
.header-btn i{font-size:13px;}

.burger-btn{
  border:none;
  background:transparent;
  color:#fff;
  padding:8px;
  border-radius:10px;
  cursor:pointer;
  line-height:1;
}
.burger-btn:hover{background:rgba(255,255,255,.12);} 
.burger-btn:focus{outline:2px solid rgba(255,255,255,.6);outline-offset:2px;}

.menu{
  position:fixed;
  top:52px;
  left:5vw;
  background:#fff;
  color:var(--ink);
  border-radius:14px;
  box-shadow:0 16px 40px rgba(0,0,0,.25);
  border:1px solid var(--rule);
  min-width:220px;
  overflow:hidden;
  display:none;
  z-index:1200;
}
.menu.open{display:block;}
.menu{
  animation:menuPop .12s ease-out;
}
@keyframes menuPop{
  from{transform:translateY(-6px);opacity:.6;}
  to{transform:translateY(0);opacity:1;}
}
.menu a{
  display:block;
  padding:14px 16px;
  text-decoration:none;
  color:var(--ink);
  border-bottom:1px solid var(--rule);
  font-weight:500;
}
.menu a:last-child{border-bottom:none;}
.menu a:hover{background:var(--hover);}

main{
  max-width:1200px;
  margin:40px auto 0;
  width:100%;
  padding:0 5vw;
  display:flex;
  flex-direction:column;
  align-items:center; /* center search box */
}

/* left-align results like Oxford layout */
#entries{
  width:100%;
  max-width:740px; /* keep existing width */
  margin:12px auto 0; /* center entries horizontally */
  align-self:center;
  padding:0;
}

/* center container for full-page messages */
#entries.centered{
  width:100%;
  max-width:740px; /* match reduced entries width */ /* keep centered messages within search bar width */
  display:flex;
  align-items:flex-start; /* slightly higher, like regular results */
  justify-content:center;
  min-height:0;
}

.search-wrapper{
  display:flex;
  background:#fff;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
  position:relative;
  overflow:visible;
  width:100%;
  max-width:860px; /* Oxford-like length on desktop */
  margin:16px auto 44px; /* extra space below search box */
}
@media (min-width: 1024px){
  .search-wrapper{max-width:860px;}
}

.search-wrapper select{
  font-weight:600;
  flex:0 0 auto;
  background:var(--gold-dark);
  color:#000;
  border:none;
  padding:14px 36px;
  min-width:90px;
  border-radius:14px 0 0 14px;
  font-size:15.5px;
  cursor:pointer;
  appearance:none;
  text-align:center;
  width:auto;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' fill='none' stroke='%231F2937' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 14px center;
}

@media (max-width: 520px){
  .search-wrapper select{
    padding:14px 18px;          /* tighter */
    min-width:44px;             /* caret only */
    font-size:0;                /* hide text */
    background-position:center; /* center caret */
  }
  .search-wrapper select option{
    font-size:15px;             /* options still readable */
  }
  .search-wrapper input{
    font-size:15px;             /* balance with smaller control */
  }
  .search-wrapper input::placeholder{
    font-size:14.5px;           /* adjusted placeholder */
  }
}
.search-wrapper select option{ text-align:center; color:#000; }

.search-wrapper input{
  flex:1 1 auto;
  min-width:0;
  border:none;
  padding:16px 18px;
  font-size:16px;
  font-weight:500;
  color:var(--ink);
}
.search-wrapper input::placeholder{ color:#9CA3AF; font-weight:500; font-size:15.5px; }
.search-wrapper input:focus{outline:none;box-shadow:none;}

.search-wrapper button{
  border-left:1px solid var(--rule); /* vertical divider before icon */

  position:relative;
  border:none;
  background:none;
  padding:0 16px;
  cursor:pointer;
  color:var(--secondary);
  border-radius:10px;
}
.search-wrapper button:hover{
  background:var(--hover);
  color:var(--ink);
}
.search-wrapper button::after{
  content:attr(data-tooltip);
  position:absolute;
  bottom:-36px;
  right:8px;
  background:#111827;
  color:#fff;
  font-size:12px;
  padding:6px 8px;
  border-radius:6px;
  white-space:nowrap;
  opacity:0;
  pointer-events:none;
  transform:translateY(-4px);
  transition:opacity .15s ease, transform .15s ease;
}
.search-wrapper button:hover::after{
  opacity:1;
  transform:translateY(0);
}
.search-wrapper button:hover{color:var(--ink);}

/* Suggestions dropdown */
.suggestions{
  position:absolute;
  top:100%;
  left:0;
  width:100%;
  background:#fff;
  border-radius:0 0 14px 14px;
  box-shadow:0 16px 40px rgba(0,0,0,.18);
  border:1px solid var(--rule);
  border-top:none;
  display:none;
  z-index:500;
  overflow:hidden;
}
.suggestions.open{
  display:grid;
  grid-template-columns:auto 1fr; /* first column matches dropdown width */
}
.suggestions .sugg-side{
  background:rgba(91,111,142,.12);
  color:var(--secondary);
  font-weight:700; /* bolder */
  font-size:13px;  /* slightly bigger */
  padding:14px 12px;
  border-right:1px solid var(--rule);
  text-align:center;
  display:flex;
  align-items:center;
  justify-content:center;
  white-space:nowrap;
}
.suggestions .sugg-list{ padding:6px 0; }
.suggestions .sugg-item{
  padding:12px 14px;
  padding-left:18px; /* align with search input text */
  cursor:pointer;
  font-size:15px;
}
.suggestions .sugg-item:hover{background:var(--hover);}

.entry{
  position:relative;
  margin:0;
  padding:16px 0; /* slightly tighter vertical spacing */
}
.entry::after{
  content:"";
  position:absolute;
  left:0;
  right:-2vw; /* reduced extension to the right */
  bottom:0;
  height:1px;
  background:var(--rule);
}

/* Centered no-match separator */
.entry.no-match::after{
  left:50%;
  right:auto;
  width:60%; /* centered line width */
  transform:translateX(-50%);
}
.headword{display:flex;align-items:baseline;gap:8px;margin-bottom:4px;}
.pron{
  display:flex;
  align-items:center;
  gap:10px;
  margin:2px 0 10px;
  color:var(--secondary);
  font-size:14px;
}
.pron .ipa{
  font-style:normal; /* NOT italic */
  font-weight:500;
  color:var(--ink);
}
.pron .ipa{font-style:italic;}
.pron button{
  border:none;
  background:transparent;
  cursor:pointer;
  padding:4px 6px;
  border-radius:999px;
}
.pron button:hover{background:var(--hover);}
.pron button:disabled{opacity:.35;cursor:not-allowed;}
.dialect,
.derivs{
  margin:0 0 8px;
  font-size:13.5px;
  line-height:1.45;
}

/* Dialect: special highlighted style */
.dialect{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  background:rgba(91,111,142,.18);
  color:var(--accent);
  font-weight:600;
  margin-bottom:8px;
}

/* Derivatives / inflections: softer, italic */
.derivs{
  color:var(--secondary);
}

.derivs .value{
  font-style:italic;
  font-weight:500;
}
.dialect .label,
.derivs .label{
  font-weight:600;
  color:var(--secondary);
}
.dialect .value,
.derivs .value{
  font-weight:500;
  font-style:italic;
  color:var(--secondary);
}
.derivs{margin-bottom:10px;}
.entry h2{
  margin:0;
  color:var(--accent);
  font-size:28px;
  font-weight:600;
  line-height:1.15;
}
.pos{font-style:italic;color:var(--secondary);font-size:14px;}
.definition{font-size:15px;line-height:1.55;}
.equivalent{color:var(--accent-soft);font-weight:500;}
.equivalent .equiv-link{color:inherit;text-decoration:none;font-weight:600;}
.gloss-link{color:inherit;text-decoration:none;font-weight:600;}
.gloss-link:hover{text-decoration:none;}
.gloss-link:focus{outline:2px solid rgba(0,31,61,.35);outline-offset:2px;border-radius:6px;}
.equivalent .equiv-link:hover{text-decoration:none;}
.equivalent .equiv-link:focus{outline:2px solid rgba(0,31,61,.35);outline-offset:2px;border-radius:6px;}

.no-match{
  text-align:center;
}
.no-match .definition{
  font-weight:600;
  font-size:16px;
  margin:0 auto;
}
.example{
  margin:8px 0;
  padding:10px 12px;
  background:var(--hover);
  border-left:4px solid var(--accent-soft);
  font-size:14px;
  line-height:1.45;
}

.notice{
  background:#fff;
  border:1px solid var(--rule);
  border-radius:14px;
  padding:14px 16px;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
  font-size:14px;
  color:var(--secondary);
}

/* Word of the Day card (Oxford-like) */
.wod-card{
  max-width:360px;
  margin:40px auto 28px; /* match header-to-search spacing */
  background:rgba(91,111,142,.16);
  border-radius:18px;
  padding:18px 18px 16px;
  text-align:center;
  box-shadow:0 14px 34px rgba(0,0,0,.12);
  border:1px solid rgba(255,255,255,.65);
}
.wod-top{
  display:flex;
  align-items:center;
  justify-content:center; /* center date */
  color:rgba(13,27,42,.72);
  font-size:14px;
  font-weight:500;
  position:relative;
}

.wod-title{
  margin:20px 0 4px;
  font-size:48px; /* larger Word of the Day */
  font-weight:700;
  color:var(--accent);
  line-height:1.05;
}
.wod-pos{
  display:block;
  font-style:italic;
  color:rgba(13,27,42,.72);
  margin-bottom:14px;
  font-size:13px; /* smaller POS */
}
.wod-actions{
  display:flex;
  align-items:center;
  justify-content:center; /* center single audio icon */
  margin:10px 0 14px;
}
.wod-actions button{
  border:none;
  background:transparent;
  cursor:pointer;
  padding:8px;
  border-radius:999px;
  position:relative;
}
.wod-actions button:hover{ background:rgba(255,255,255,.55); }

/* Listen tooltip */
.wod-actions button::after{
  content:attr(data-tooltip);
  position:absolute;
  bottom:-34px;
  left:50%;
  transform:translateX(-50%) translateY(-4px);
  background:#111827;
  color:#fff;
  font-size:12px;
  padding:6px 8px;
  border-radius:6px;
  white-space:nowrap;
  opacity:0;
  pointer-events:none;
  transition:opacity .15s ease, transform .15s ease;
}
.wod-actions button:hover::after{
  opacity:1;
  transform:translateX(-50%) translateY(0);
}

/* Disabled state */
.wod-actions button:disabled{
  opacity:.35;
  cursor:not-allowed;
}
.wod-actions button:disabled:hover{ background:transparent; }
.wod-actions button:disabled::after{ opacity:0; }
.wod-actions .wod-a2{ color:#BE123C; font-size:22px; }
.wod-sub{
  color:rgba(13,27,42,.72);
  font-size:13px;
  margin:6px 0 10px;
}
.wod-pill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:10px 14px;
  border-radius:999px;
  background:var(--accent);
  color:#fff;
  font-weight:600;
  letter-spacing:.3px;
  font-size:13px;
  min-width:220px;
}
.wod-level{
  display:inline-block;
  margin-top:10px;
  padding:4px 8px;
  border-radius:8px;
  background:rgba(17,24,39,.18);
  color:rgba(13,27,42,.9);
  font-weight:700;
  font-size:12px;
}
.wod-foot{
  margin-top:10px;
  font-size:11px;
  color:rgba(13,27,42,.65);
}

.wod-link{
  color:var(--accent);
  text-decoration:none;
  font-weight:700;
}
.wod-link:hover{ text-decoration:none; }

@media (max-width: 420px){
  .wod-card{ max-width:100%; }
  .wod-pill{ min-width:0; width:100%; }
}

.wod-meaning{
  display:none; /* keep Oxford-like card clean; word opens entry on click */
}

.wod-link{
  color:var(--accent);
  text-decoration:none;
  font-weight:600;
}
.wod-link:hover{ text-decoration:none; }

footer{
  margin-top:auto;
  padding:24px 5vw;
  text-align:center;
  font-size:12px;
  color:var(--secondary);
  border-top:1px solid var(--rule);
}


/* Remove blue autofill background */
input:-webkit-autofill,
input:-webkit-autofill:hover,
input:-webkit-autofill:focus,
input:-webkit-autofill:active {
  -webkit-box-shadow:0 0 0px 1000px #fff inset !important;
  -webkit-text-fill-color:var(--ink) !important;
  transition:background-color 5000s ease-in-out 0s;
}


</style>
</head>

<body>
<header>
  <div class="header-left">
    <button class="burger-btn" id="burger" type="button" aria-label="Open menu" aria-haspopup="true" aria-expanded="false">
      <i class="fa-solid fa-bars"></i>
    </button>
    <h1><a href="#" class="site-title" id="homeLink">Bikol Dictionary</a></h1>
  </div>

  <div class="header-right">
  <button class="header-btn" type="button" aria-label="Help">
    <i class="fa-regular fa-circle-question"></i>
    Help
  </button>
</div>
</header>

<nav class="menu" id="menu" aria-label="Site menu">
  <a href="#about">About</a>
  <a href="#grammar">Grammar</a>
  <a href="#resources">Resources</a>
  <a href="#contact">Contact</a>
  <a href="#donate">Donate</a>
</nav>

<main>
  <div class="search-wrapper">
    <select id="lang">
      <option value="english" data-short="English" data-long="English – Bikol">English</option>
      <option value="bikol" data-short="Bikol" data-long="Bikol – English">Bikol</option>
    </select>
    <input id="search" placeholder="Search English - Bikol Dictionary" autocomplete="off" />
    <button id="searchBtn" type="button" aria-label="Search" data-tooltip="Search"><i class="fa-solid fa-magnifying-glass"></i></button>
    <div class="suggestions" id="suggestions"></div>
  </div>

  <div class="wod-card" id="wordOfDay" role="region" aria-label="Word of the day">
    <div class="wod-top">
      <div id="wod-date">—</div>
      
    </div>

    <div class="wod-title"><span id="wod-word">—</span></div>
    <span class="wod-pos" id="wod-pos"></span>

    <div class="wod-actions">
      <button type="button" id="wodListenBtn" class="wod-listen" aria-label="Listen" data-tooltip="Listen">
        <i class="fa-solid fa-volume-high wod-a2"></i>
      </button>
    </div>

    
    <div class="wod-pill" id="wod-list">Bikol Word of the Day</div>
    <div class="wod-level" id="wod-level" style="display:none;">A2</div>

    
    <span class="wod-meaning" id="wod-meaning"></span>
  </div>

  <div id="entries"></div>
</main>

<footer>© 2026 Jusan Misolas. All rights reserved.</footer>

<!--
Fallback sample (ONLY used if english_to_bikol.csv cannot be fetched in a sandboxed preview).
Keep your real database in: english_to_bikol.csv
-->
<script type="text/plain" id="csv-fallback">english,pos,sense1_meaning,sense1_bikol,sense1_example,sense2_meaning,sense2_bikol,sense2_example,sense3_meaning,sense3_bikol,sense3_example,sense4_meaning,sense4_bikol,sense4_example,sense5_meaning,sense5_bikol,sense5_example,sense6_meaning,sense6_bikol,sense6_example,sense7_meaning,sense7_bikol,sense7_example,sense8_meaning,sense8_bikol,sense8_example,sense9_meaning,sense9_bikol,sense9_example,sense10_meaning,sense10_bikol,sense10_example
run,verb,to move swiftly on foot,dalagan,May nahiling akong nagdadalagan na ikos.||I saw a cat running.,to manage or operate something,padalagan,Matibay syang magpadalagan nin negosyo.||She is good at running business.,,,,,,,,,,,,,,,,,,,,,,,,
house,noun,a building for people to live in,harong,Ini an samuyang harong.||This is our house.,,,,,,,,,,,,,,,,,,,,,,,,,,,
eat,verb,to put food into the mouth and swallow,kakan,Nagkakan kami subagong aga.||We ate this morning.,,,,,,,,,,,,,,,,,,,,,,,,,,,
big,adjective,of large size,dakula,Dakula an harong.||The house is big.,,,,,,,,,,,,,,,,,,,,,,,,,,,
</script>

<!-- Optional fallback for bikol_to_english.csv (used only when CSV fetch is blocked) -->
<script type="text/plain" id="csv-fallback-bi">bikol,pos,ipa,audio_url,dialect,derivatives_inflections,wod,featured,sense1_gloss,sense1_meaning,sense1_example,sense2_gloss,sense2_meaning,sense2_example,sense3_gloss,sense3_meaning,sense3_example,sense4_gloss,sense4_meaning,sense4_example,sense5_gloss,sense5_meaning,sense5_example,sense6_gloss,sense6_meaning,sense6_example,sense7_gloss,sense7_meaning,sense7_example,sense8_gloss,sense8_meaning,sense8_example,sense9_gloss,sense9_meaning,sense9_example,sense10_gloss,sense10_meaning,sense10_example
kakan,verb,kakán,,Naga Bikol,"kakan, nagkakan, magkakan",yes,,eat,to put food into the mouth and swallow,Nagkakan kami subagong aga.||We ate this morning.,,,,,,,,,,,,,,,,,,,,,,,,,,,
dalagan,verb,dalágan,,,"dalagan, nagdadalagan, magdalagan",,,run,to move swiftly on foot,May nahiling akong nagdadalagan na ikos.||I saw a cat running.,operate,to manage or operate something,Matibay siyang magpadalagan nin negosyo.||She runs a business.,,,,,,,,,,,,,,,,,,,,,,,,
harong,noun,haróng,,,,,house,a building for people to live in,Ini an samuyang harong.||This is our house.,,,,,,,,,,,,,,,,,,,,,,,,,,,
dakula,adjective,dakulâ,,,,,big,of large size,Dakula an harong.||The house is big.,,,,,,,,,,,,,,,,,,,,,,,,,,,
</script>

<script>
// CSV is separate: put english_to_bikol.csv beside this HTML.
// In some previews/sandboxes, file fetch is blocked. If that happens, we fall back to a tiny sample.

let dictionaryEN = [];
let dictionaryBI = [];
let dataReady = false; // set true after CSV loads
let pendingRoute = null; // holds parsed hash until data is ready

const burger = document.getElementById("burger");
const menu = document.getElementById("menu");
const search = document.getElementById("search");
const suggestions = document.getElementById("suggestions");
const entries = document.getElementById("entries");
const lang = document.getElementById("lang");
const searchBtn = document.getElementById("searchBtn");

const wordOfDay = document.getElementById("wordOfDay");
const wodDate = document.getElementById("wod-date");
const wodWord = document.getElementById("wod-word");
const wodPos = document.getElementById("wod-pos");
const wodList = document.getElementById("wod-list");
const wodLevel = document.getElementById("wod-level");
const wodMeaning = document.getElementById("wod-meaning");
const wodListenBtn = document.getElementById("wodListenBtn");

let currentWod = null;
let wodAudio = null; // HTMLAudioElement when an audio URL is provided

// Hash routing: #/english/<term> or #/bikol/<term>
let currentRouteKey = "";

function buildRouteKey(mode, term){
  return String(mode || "") + "|" + String(term || "").toLowerCase();
}

function parseHashRoute(){
  const h = (window.location.hash || "").replace(/^#/, "");
  if (!h) return null;
  const parts = h.split("/").filter(Boolean); // remove empty
  if (parts.length < 2) return null;
  const mode = (parts[0] || "").toLowerCase();
  const term = decodeURIComponent(parts.slice(1).join("/") || "").trim();
  if (!term) return null;
  if (mode !== "english" && mode !== "bikol") return null;
  return { mode, term };
}

function setHashRoute(mode, term, replace){
  const safeMode = (mode === "bikol") ? "bikol" : "english";
  const safeTerm = String(term || "").trim();
  if (!safeTerm) return;
  const next = "#/" + safeMode + "/" + encodeURIComponent(safeTerm);
  if (replace) {
    history.replaceState(null, "", next);
  } else {
    window.location.hash = next;
  }
}

function clearHashRoute(){
  history.replaceState(null, "", " ");
  // Some browsers keep a trailing space in the URL bar if we leave it as-is.
  history.replaceState(null, "", window.location.pathname + window.location.search);
}

function findExactByMode(mode, term){
  const q = String(term || "").trim().toLowerCase();
  if (!q) return null;

  const dict = (mode === "bikol") ? dictionaryBI : dictionaryEN;
  const field = (mode === "bikol") ? "bikol" : "english";

  return dict.find(row => (row[field] || "").toLowerCase() === q) || null;
}

function applyRouteFromHash(){
  // Wait until CSV is loaded before resolving deep links.
  if (!dataReady) {
    pendingRoute = parseHashRoute();
    return;
  }
  const r = parseHashRoute();
  if (!r) {
    // Home view
    search.value = "";
    entries.innerHTML = "";
    closeSuggestions();
    syncWordOfDayVisibility();
    currentRouteKey = "";
    return;
  }

  const key = buildRouteKey(r.mode, r.term);
  if (key === currentRouteKey) return;

  // Set dropdown (keep short captions)
  lang.value = (r.mode === "bikol") ? "bikol" : "english";
  setLangOptionsShort();

  closeSuggestions();
  search.value = "";
  hideWordOfDay();

  const match = findExactByMode(r.mode, r.term);
  if (match) {
    currentRouteKey = key;
    render(match);
  } else {
    currentRouteKey = key;
    noMatch(r.term);
  }
}

function escapeHtml(str) {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function closeSuggestions(){
  suggestions.classList.remove("open");
  suggestions.innerHTML = "";
}

function hideWordOfDay(){
  if (wordOfDay) wordOfDay.style.display = "none";
}

function showWordOfDay(){
  if (wordOfDay) wordOfDay.style.display = "";
}

function isTruthy(v){
  const s = String(v ?? "").trim().toLowerCase();
  return s === "1" || s === "true" || s === "yes" || s === "y" || s === "wod";
}

function isHomeView(){
  return (search.value || "").trim() === "" && (entries.innerHTML || "").trim() === "";
}

function pickWordOfDay(rows){
  // TEMP: force Word of the Day to "kakan" for this chat
  const forced = rows.find(r => (r.bikol || "").toLowerCase() === "kakan");
  if (forced) return forced;

  // MANUAL Word of the Day only (fallback)
  const curated = rows.filter(r =>
    isTruthy(r.wod) || isTruthy(r.word_of_day) || isTruthy(r.wordOfDay) || isTruthy(r.wotd) || isTruthy(r.featured)
  );

  if (!curated.length) return null;

  const dayIndex = Math.floor(Date.now() / 86400000);
  const idx = dayIndex % curated.length;
  return curated[idx];
}

function formatWodDate(d){
  // e.g., 18 January 2026
  try {
    const dt = new Date(d);
    const day = dt.getDate();
    const month = dt.toLocaleString(undefined, { month: "long" });
    const year = dt.getFullYear();
    return day + " " + month + " " + year;
  } catch {
    return "";
  }
}

function setWordOfDay(){
  if (!wordOfDay || !wodWord || !wodPos) return;
  if (!dictionaryBI.length) return;

  // Word of the day comes from the Bikol -> English database
  const picked = pickWordOfDay(dictionaryBI);
  if (!picked) return;

  currentWod = picked;

  const word = picked.bikol || "";
  const pos = picked.pos || "";
  const gloss = picked.sense1_gloss || "";
  const meaning = picked.sense1_meaning || "";

  // date
  if (wodDate) wodDate.textContent = formatWodDate(Date.now());

  // clickable word
  wodWord.innerHTML = '<a href="#" class="wod-link" id="wodLink">' + escapeHtml(word) + '</a>';
  wodPos.textContent = pos ? pos : "";

  // capsule label
  if (wodList) wodList.textContent = "Bikol Word of the Day";

  // optional level
  const lvl = (picked.level || picked.cefr || "");
  if (wodLevel) {
    if (String(lvl).trim()) {
      wodLevel.style.display = "inline-block";
      wodLevel.textContent = String(lvl).trim();
    } else {
      wodLevel.style.display = "none";
    }
  }

  // meaning text (used for display)
  if (wodMeaning) {
    let line = "";
    if (gloss) line += gloss;
    if (meaning) line += (line ? " — " : "") + meaning;
    wodMeaning.textContent = line || "";
  }

  // Listen button: enabled ONLY when an audio URL exists (no speechSynthesis)
  const audioUrl = (picked.audio_url || picked.audioUrl || picked.audio || "").toString().trim();
  if (wodListenBtn) {
    if (audioUrl) {
      wodAudio = new Audio(audioUrl);
      wodListenBtn.disabled = false;
      wodListenBtn.setAttribute("aria-label", "Listen");
    } else {
      wodAudio = null;
      wodListenBtn.disabled = true;
      wodListenBtn.setAttribute("aria-label", "Audio unavailable");
    }
  }

  const wodLink = document.getElementById("wodLink");
  wodLink.addEventListener("click", (e) => {
    e.preventDefault();
    // Navigate to a shareable URL for this entry
    const term = (picked.bikol || "").trim();
    if (!term) return;
    setHashRoute("bikol", term, false);
    applyRouteFromHash();
  });
}

// Listen button behavior (plays provided audio URL only)
if (wodListenBtn){
  wodListenBtn.addEventListener("click", () => {
    if (wodListenBtn.disabled) return;
    if (!wodAudio) return;

    try {
      wodAudio.currentTime = 0;
      wodAudio.play();
    } catch {}
  });
}


function syncWordOfDayVisibility(){
  if (!wordOfDay) return;
  if (isHomeView()) {
    showWordOfDay();
    setWordOfDay();
  } else {
    hideWordOfDay();
  }
}

function buildExampleHTML(ex){
  if (!ex) return "";
  const parts = String(ex).split("||");
  const bik = parts[0] ? escapeHtml(parts[0]) : "";
  const eng = parts[1] ? escapeHtml(parts[1]) : "";
  let html = '<div class="example">' + bik;
  if (eng) html += '<br><em>' + eng + '</em>';
  html += '</div>';
  return html;
}

// Turn Bikol equivalents into deep links (to the Bikol → English entry)
function linkifyBikolEquivalents(text){
  const raw = String(text || "").trim();
  if (!raw) return "";

  // Split on separators; also split on the word "or" (simple, space-based)
  const chunks = raw.split(/[,;/|]+/);
  const tokens = [];
  chunks.forEach(c => {
    const p = String(c || "");
    // Handle " or " in a basic way without regex backslashes
    const sub = p.split(" or ").flatMap(x => x.split(" OR "));
    sub.forEach(t => {
      const term = String(t || "").trim();
      if (term) tokens.push(term);
    });
  });

  return tokens.map(term => {
    const href = "#/bikol/" + encodeURIComponent(term);
    return '<a href="' + href + '" class="equiv-link" title="Open Bikol entry">' + escapeHtml(term) + '</a>';
  }).join(", ");
}

// Turn English glosses into deep links (to the English → Bikol entry)
function linkifyEnglishGloss(text){
  const raw = String(text || "").trim();
  if (!raw) return "";

  // Often a single headword; but allow basic multi-term separators.
  const chunks = raw.split(/[,;/|]+/);
  const tokens = [];
  chunks.forEach(c => {
    const term = String(c || "").trim();
    if (term) tokens.push(term);
  });

  return tokens.map(term => {
    const href = "#/english/" + encodeURIComponent(term);
    return '<a href="' + href + '" class="gloss-link" title="Open English entry">' + escapeHtml(term) + '</a>';
  }).join(", ");
}

function getDialect(d){
  return (d.dialect || "").toString().trim();
}

function dialectHTML(d){
  const v = getDialect(d);
  if (!v) return "";
  return '<div class="dialect"><span class="value">' + escapeHtml(v) + '</span></div>';
}


function getDerivs(d){
  return (d.derivatives || d.inflections || d.derivatives_inflections || "").toString().trim();
}

function derivsHTML(d){
  const v = getDerivs(d);
  if (!v) return "";
  return '<div class="derivs"><span class="value">' + escapeHtml(v) + '</span></div>';
}


function dictForMode(){
  return (lang.value === "english") ? dictionaryEN : dictionaryBI;
}

function fieldForMode(){
  return (lang.value === "english") ? "english" : "bikol";
}

function renderEnglish(d){
  // update URL
  if (d && d.english) {
    const k = buildRouteKey("english", d.english);
    if (k !== currentRouteKey) {
      currentRouteKey = k;
      setHashRoute("english", d.english, true);
    }
  }
  entries.classList.remove("centered");
  closeSuggestions();

  const senses = [];
  for (let i = 1; i <= 10; i++) {
    const m = d["sense" + i + "_meaning"] || "";
    const b = d["sense" + i + "_bikol"] || "";
    const ex = d["sense" + i + "_example"] || "";
    if (!m) continue;
    senses.push({ m, b, ex });
  }

  let sensesHtml = "";
  if (senses.length === 1) {
    const s = senses[0];
    sensesHtml += '<div class="definition">' + escapeHtml(s.m) + '</div>';
    if (s.b) sensesHtml += '<div class="definition equivalent">' + linkifyBikolEquivalents(s.b) + '</div>';
    sensesHtml += buildExampleHTML(s.ex);
  } else if (senses.length > 1) {
    senses.forEach((s, idx) => {
      sensesHtml += '<div style="margin-top:18px;">';
      sensesHtml += '<div class="definition"><strong>' + (idx + 1) + '.</strong> ' + escapeHtml(s.m) + '</div>';
      if (s.b) sensesHtml += '<div class="definition equivalent">' + linkifyBikolEquivalents(s.b) + '</div>';
      sensesHtml += buildExampleHTML(s.ex);
      sensesHtml += '</div>';
    });
  } else {
    sensesHtml = '<div class="definition">No senses available.</div>';
  }

  entries.innerHTML =
    '<div class="entry">' +
      '<div class="headword">' +
        '<h2>' + escapeHtml(d.english || "") + '</h2>' +
        '<span class="pos">' + escapeHtml(d.pos || "") + '</span>' +
      '</div>' +
      sensesHtml +
    '</div>';

  // attach audio handlers (Bikol headword pronunciation)
  entries.querySelectorAll('.pron-play').forEach(btn => {
    const src = btn.getAttribute('data-audio');
    if (!src) return;
    const audio = new Audio(src);
    btn.addEventListener('click', () => {
      try { audio.currentTime = 0; audio.play(); } catch(e){}
    });
  });
}


function renderBikol(d){
  // update URL
  if (d && d.bikol) {
    const k = buildRouteKey("bikol", d.bikol);
    if (k !== currentRouteKey) {
      currentRouteKey = k;
      setHashRoute("bikol", d.bikol, true);
    }
  }

  entries.classList.remove("centered");
  closeSuggestions();

  const senses = [];
  for (let i = 1; i <= 10; i++) {
    const g = d["sense" + i + "_gloss"] || "";
    const m = d["sense" + i + "_meaning"] || "";
    const ex = d["sense" + i + "_example"] || "";
    if (!g && !m && !ex) continue;
    senses.push({ g, m, ex });
  }

  let sensesHtml = "";
  if (senses.length === 1) {
    const s = senses[0];
    if (s.g) sensesHtml += '<div class="definition">' + linkifyEnglishGloss(s.g) + '</div>';
    if (s.m) sensesHtml += '<div class="definition">' + escapeHtml(s.m) + '</div>';
    sensesHtml += buildExampleHTML(s.ex);
  } else if (senses.length > 1) {
    senses.forEach((s, idx) => {
      sensesHtml += '<div style="margin-top:18px;">';
      sensesHtml += '<div class="definition"><strong>' + (idx + 1) + '.</strong> ' + linkifyEnglishGloss(s.g) + '</div>';
      if (s.m) sensesHtml += '<div class="definition">' + escapeHtml(s.m) + '</div>';
      sensesHtml += buildExampleHTML(s.ex);
      sensesHtml += '</div>';
    });
  } else {
    sensesHtml = '<div class="definition">No senses available.</div>';
  }

  // Pronunciation row (Bikol → English): ALWAYS show audio button
  let ipa = (d.ipa || d.pron || d.pronunciation || "").toString().trim().replace(/^\/+|\/+$/g, "");
  const audioUrl = (d.audio_url || d.audioUrl || d.audio || "").toString().trim();

  let pronHtml = '<div class="pron">';
  if (audioUrl) {
    pronHtml += '<button type="button" class="pron-play" aria-label="Listen" data-audio="' + escapeHtml(audioUrl) + '"><i class="fa-solid fa-volume-high"></i></button>';
  } else {
    pronHtml += '<button type="button" class="pron-play" aria-label="Audio unavailable" disabled><i class="fa-solid fa-volume-high"></i></button>';
  }
  if (ipa) {
    pronHtml += '<span class="ipa">/' + escapeHtml(ipa) + '/</span>';
  }
  pronHtml += '</div>';

  // TEMP preview-only sample for "kakan" when fields are blank
  let dialectBlock = dialectHTML(d);
  let derivsBlock = derivsHTML(d);
  if ((d.bikol || "").toLowerCase() === "kakan" && !dialectBlock && !derivsBlock) {
    dialectBlock = '<div class="dialect"><span class="value">Naga Bikol</span></div>';
    derivsBlock = '<div class="derivs"><span class="value">kakan, nagkakan, magkakan</span></div>';
  }

  entries.innerHTML =
    '<div class="entry">' +
      '<div class="headword">' +
        '<h2>' + escapeHtml(d.bikol || "") + '</h2>' +
        '<span class="pos">' + escapeHtml(d.pos || "") + '</span>' +
      '</div>' +
      pronHtml +
      dialectBlock +
      derivsBlock +
      sensesHtml +
    '</div>';

  // attach audio handlers
  entries.querySelectorAll('.pron-play').forEach(btn => {
    const src = btn.getAttribute('data-audio');
    if (!src) return;
    const audio = new Audio(src);
    btn.addEventListener('click', () => {
      try { audio.currentTime = 0; audio.play(); } catch(e){}
    });
  });
}


function render(d){
  entries.classList.remove("centered");
  if (lang.value === "english") return renderEnglish(d);
  return renderBikol(d);
}

function noMatch(term){
  hideWordOfDay();
  const modeText = (lang.value === "english") ? "English - Bikol" : "Bikol - English";
  const safeTerm = escapeHtml(term || "");

  // center the message in the page
  entries.classList.add("centered");

  entries.innerHTML =
    '<div class="entry no-match">' +
      '<div class="definition">' +
        'No exact match found for "' + safeTerm + '" in ' + modeText + ' Dictionary' +
      '</div>' +
    '</div>';
}

function performSearch(){
  hideWordOfDay();
  const original = (search.value || "").trim();
  const q = original.toLowerCase();
  if (!q) return;

  const dict = dictForMode();
  const field = fieldForMode();

  // exact match only (no prefix matching)
  const match = dict.find(row => (row[field] || "").toLowerCase() === q);

  if (match) {
    render(match);
  } else {
    noMatch(original);
  }
}

function updateSuggestions(){
  const q = search.value.toLowerCase().trim();
  entries.innerHTML = "";
  closeSuggestions();

  // Word of the day only shows on Home (no search + no results)
  if (!q) {
    syncWordOfDayVisibility();
    return;
  }

  hideWordOfDay();

  const dict = dictForMode();
  const field = fieldForMode();
  const matches = dict.filter(row => (row[field] || "").toLowerCase().startsWith(q));
  if (!matches.length) return;

  suggestions.classList.add("open");

  const side = document.createElement("div");
  side.className = "sugg-side";
  side.textContent = (lang.value === "english") ? "English to Bikol" : "Bikol to English";

  const list = document.createElement("div");
  list.className = "sugg-list";

  matches.slice(0, 12).forEach(row => {
    const item = document.createElement("div");
    item.className = "sugg-item";
    item.textContent = row[field];
    item.addEventListener("click", () => {
      hideWordOfDay();
      /* clear whatever the user typed, then render */
      search.value = "";
      render(row);
    });
    list.appendChild(item);
  });

  suggestions.appendChild(side);
  suggestions.appendChild(list);
}

// NOTE: buildReverse removed. Bikol → English is now MANUAL only.
// Keep entries exclusively from bikol_to_english.csv.

function setDataFromFiles(enRows, biRows){
  dictionaryEN = (enRows || []).filter(row => row.english);

  // Bikol → English is MANUAL ONLY
  dictionaryBI = (Array.isArray(biRows) ? biRows : []).filter(r => (r.bikol || "").toString().trim());

  dataReady = true;

  // Ensure deep-links render after data loads
  currentRouteKey = "";
  applyRouteFromHash();

  // initial placeholder
  if (lang.value === "english") {
    search.placeholder = "Search English - Bikol Dictionary";
  } else {
    search.placeholder = "Search Bikol - English Dictionary";
  }

  syncWordOfDayVisibility();
}

function showNotice(html){
  entries.innerHTML = '<div class="notice">' + html + '</div>';
}

function loadCsvFromText(csvText){
  Papa.parse(csvText, {
    header:true,
    skipEmptyLines:true,
    complete:(r) => {
      setDataFromFiles(r.data || [], null);
    }
  });
}

function loadCsvFromTextPair(enText, biText){
  Papa.parse(enText, {
    header:true,
    skipEmptyLines:true,
    complete:(enRes) => {
      Papa.parse(biText, {
        header:true,
        skipEmptyLines:true,
        complete:(biRes) => {
          setDataFromFiles(enRes.data || [], biRes.data || []);
        }
      });
    }
  });
}

function loadCsvFromFile(){
  const enUrl = "english_to_bikol.csv?" + Date.now();
  const biUrl = "bikol_to_english.csv?" + Date.now();

  Papa.parse(enUrl, {
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:(enRes) => {
      // Try load separate Bikol→English; if it fails, we will derive from English→Bikol.
      Papa.parse(biUrl, {
        download:true,
        header:true,
        skipEmptyLines:true,
        complete:(biRes) => {
          setDataFromFiles(enRes.data || [], biRes.data || []);
        },
        error:() => {
          // No Bikol CSV = empty Bikol dictionary
          setDataFromFiles(enRes.data || [], []);
        }
      });
    },
    error:() => {
      // Sandbox preview fallback (both)
      const fallbackEN = document.getElementById("csv-fallback");
      const fallbackBI = document.getElementById("csv-fallback-bi");
      const enText = (fallbackEN && fallbackEN.textContent) ? fallbackEN.textContent : "";
      const biText = (fallbackBI && fallbackBI.textContent) ? fallbackBI.textContent : "";

      if (enText && biText) {
        loadCsvFromTextPair(enText, biText);
      } else {
        loadCsvFromText(enText || "");
      }

      showNotice(
        '<strong>CSV not loaded.</strong> This preview cannot fetch CSV files.<br>' +
        'On GitHub Pages, keep <code>english_to_bikol.csv</code> (required) and <code>bikol_to_english.csv</code> (optional) beside this HTML.'
      );
    }
  });
}

// Home link behavior
const homeLink = document.getElementById("homeLink");
homeLink.addEventListener("click", (e) => {
  e.preventDefault();
  clearHashRoute();
  search.value = "";
  entries.innerHTML = "";
  closeSuggestions();
  syncWordOfDayVisibility();
  currentRouteKey = "";
  window.scrollTo({ top: 0, behavior: "smooth" });
});

// Events
search.addEventListener("input", updateSuggestions);
search.addEventListener("keydown", (e) => {
  if (e.key === "Enter") performSearch();
});
searchBtn.addEventListener("click", performSearch);

// Show long labels only while dropdown is open
function setLangOptionsLong(){
  Array.from(lang.options).forEach(opt => {
    if (opt.dataset.long) opt.textContent = opt.dataset.long;
  });
}
function setLangOptionsShort(){
  Array.from(lang.options).forEach(opt => {
    if (opt.dataset.short) opt.textContent = opt.dataset.short;
  });
}

lang.addEventListener("mousedown", setLangOptionsLong);
lang.addEventListener("focus", setLangOptionsLong);
lang.addEventListener("blur", setLangOptionsShort);

lang.addEventListener("change", () => {
  // update placeholder based on language
  if (lang.value === "english") {
    search.placeholder = "Search English - Bikol Dictionary";
  } else {
    search.placeholder = "Search Bikol - English Dictionary";
  }
  setLangOptionsShort();
  closeSuggestions();
  entries.innerHTML = "";
  search.value = "";
  syncWordOfDayVisibility();
  search.focus();
});

burger.addEventListener("click", () => {
  const isOpen = menu.classList.toggle("open");
  burger.setAttribute("aria-expanded", isOpen ? "true" : "false");
});

document.addEventListener("click", (e) => {
  if (!e.target.closest(".search-wrapper")) closeSuggestions();

  if (menu.classList.contains("open") && !e.target.closest("#menu") && !e.target.closest("#burger")) {
    menu.classList.remove("open");
    burger.setAttribute("aria-expanded", "false");
  }
});

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    closeSuggestions();
    if (menu.classList.contains("open")) {
      menu.classList.remove("open");
      burger.setAttribute("aria-expanded", "false");
    }
  }
});
// Load CSV
loadCsvFromFile();
// Initial visibility
applyRouteFromHash();
syncWordOfDayVisibility();

// Tests (console)
function assert(condition, message){
  if (!condition) throw new Error(message);
}

// Route handling (back/forward + pasted links)
window.addEventListener("hashchange", () => {
  applyRouteFromHash();
});

(function runTests(){
  try {
    assert(document.getElementById("lang"), "Lang select should exist");
    assert(document.getElementById("search"), "Search input should exist");
    assert(document.getElementById("suggestions"), "Suggestions container should exist");
    assert(document.getElementById("wordOfDay"), "Word of Day block should exist");
    assert(typeof setWordOfDay === "function", "setWordOfDay should exist");
    console.log("Smoke tests passed");
  } catch (e) {
    console.error("Smoke tests failed:", e);
  }
})();
</script>
</body>
</html>
