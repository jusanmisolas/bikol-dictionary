<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Bikol Dictionary</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --primary:#0D1B2A;
  --secondary:#4B5563;
  --ink:#1F2937;
  --paper:#F8F9FA;
  --panel:#FFFFFF;
  --accent:#001F3D;
  --accent-soft:#5B6F8E;
  --gold-dark:#E3C45A;
  --hover:#F1F3F5;
  --rule:#E6E8EB;
  --radius-lg:18px;
  --radius-md:14px;
  --radius-sm:10px;
  --btn-shadow:0 10px 20px rgba(0,0,0,.12);
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:"IBM Plex Sans",sans-serif;
  background:
    radial-gradient(1200px 600px at 50% -200px, rgba(13,27,42,.08), transparent 60%),
    linear-gradient(180deg, #f7f9fb 0%, #f3f6f9 100%);
  color:var(--ink);
  line-height:1.6;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
.skip-link{
  position:absolute;
  left:-999px;
  top:10px;
  padding:8px 12px;
  background:var(--accent);
  color:#fff;
  border-radius:8px;
  text-decoration:none;
  font-weight:600;
  z-index:2000;
}
.skip-link:focus{
  left:10px;
}
button:focus-visible,
input:focus-visible,
textarea:focus-visible,
select:focus-visible,
a:focus-visible{
  outline:2px solid rgba(0,31,61,.35);
  outline-offset:2px;
  border-radius:8px;
}

header{
  background:var(--accent);
  color:#fff;
  min-height:58px; /* match search box height */
  padding:0 1vw; /* align closer to search width */
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  z-index:1000;
}
.header-inner{
  width:100%;
  max-width:1020px;
  margin:0 auto;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.header-left{display:flex;align-items:center;gap:8px;}
header h1{font-size:18px;margin:0;}
.site-title{
  color:#fff;
  text-decoration:none;
  font-weight:600;
}
.site-title:hover{
  text-decoration:none; /* keep title clean on hover */
}

.header-right{display:flex;align-items:center;gap:8px;}


.header-btn{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.55);
  background:rgba(255,255,255,.08);
  color:#fff;
  font-size:13px;
  font-weight:500;
  cursor:pointer;
  min-height:36px;
  transition:transform .12s ease, background .12s ease;
}
.header-btn:hover{background:rgba(255,255,255,.14);} 
.header-btn:active{background:rgba(255,255,255,.22);}
.header-btn i{font-size:13px;}

.submit-btn{
  background:rgba(255,255,255,.12);
  border-color:rgba(255,255,255,.65);
}
.submit-btn:hover{background:rgba(255,255,255,.22);}

.donate-btn{
  background:rgba(255,255,255,.12);
  border-color:rgba(255,255,255,.65);
}
.donate-btn:hover{background:rgba(255,255,255,.22);}

.burger-btn{
  border:none;
  background:transparent;
  color:#fff;
  padding:8px;
  border-radius:10px;
  cursor:pointer;
  line-height:1;
}
.burger-btn:hover{background:rgba(255,255,255,.12);} 
.burger-btn:focus{outline:2px solid rgba(255,255,255,.6);outline-offset:2px;}

.menu{
  position:fixed;
  top:52px;
  left:1.5vw;
  background:#fff;
  color:var(--ink);
  border-radius:var(--radius-md);
  box-shadow:0 16px 40px rgba(0,0,0,.25);
  border:1px solid var(--rule);
  min-width:220px;
  max-width:calc(100vw - 24px);
  overflow:hidden;
  display:none;
  z-index:1200;
}
.menu.open{display:block;}
.menu{
  animation:menuPop .12s ease-out;
}
@keyframes menuPop{
  from{transform:translateY(-6px);opacity:.6;}
  to{transform:translateY(0);opacity:1;}
}
.menu a{
  display:block;
  padding:14px 16px;
  text-decoration:none;
  color:var(--ink);
  border-bottom:1px solid var(--rule);
  font-weight:500;
}
.menu a:last-child{border-bottom:none;}
.menu a:hover{background:var(--hover);}

main{
  max-width:1200px;
  margin:18px auto 0;
  width:100%;
  padding:0 1.5vw;
  display:flex;
  flex-direction:column;
  align-items:center; /* center search box */
  padding-bottom:calc(120px + env(safe-area-inset-bottom));
}

/* left-align results like Oxford layout */
#entries{
  width:100%;
  max-width:1020px; /* align with search box */
  margin:12px auto 0; /* center with search box */
  align-self:center;
  padding:0;
}
#entries:not(.centered):not(:empty){
  padding:12px 16px;
  border-radius:var(--radius-md);
  background:#fff;
  box-shadow:0 8px 26px rgba(0,0,0,.08);
  border:1px solid var(--rule);
}

/* center container for full-page messages */
#entries.centered{
  width:100%;
  max-width:1020px; /* match search box width */ /* keep centered messages within search bar width */
  display:flex;
  align-items:flex-start; /* slightly higher, like regular results */
  justify-content:center;
  min-height:0;
}

.search-wrapper{
  display:flex;
  background:#fff;
  border-radius:var(--radius-md);
  box-shadow:0 10px 30px rgba(0,0,0,.15);
  position:relative;
  overflow:visible;
  width:100%;
  max-width:1020px; /* reduced length on desktop */
  margin:6px auto 18px; /* extra space below search box */
  transition:transform .2s ease, box-shadow .2s ease;
  align-items:stretch;
}
.search-wrapper:focus-within{
  box-shadow:0 0 0 3px rgba(13,27,42,.12), 0 10px 30px rgba(0,0,0,.12);
  transform:translateY(-1px);
}
@media (min-width: 1024px){
  .search-wrapper{max-width:1020px;}
}

.search-wrapper select{
  font-weight:600;
  flex:0 0 auto;
  background:var(--gold-dark);
  color:#000;
  border:none;
  padding:14px 36px;
  min-width:90px;
  border-radius:var(--radius-md) 0 0 var(--radius-md);
  font-size:15.5px;
  cursor:pointer;
  appearance:none;
  text-align:center;
  width:auto;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' fill='none' stroke='%231F2937' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 14px center;
}

@media (max-width: 900px){
  .search-wrapper input{
    font-size:16px;             /* prevent iOS zoom on focus */
  }
  .search-wrapper input::placeholder{
    font-size:15px;             /* adjusted placeholder */
  }
}

@media (max-width: 520px){
  .search-wrapper select{
    padding:14px 18px;          /* tighter */
    min-width:44px;             /* caret only */
    font-size:0;                /* hide text */
    background-position:center; /* center caret */
  }
  .search-wrapper select option{
    font-size:15px;             /* options still readable */
  }
}

@media (max-width: 1200px){
  main{ align-items:stretch; }
  .wod-row{ justify-content:center; }
  #entries{
    max-width:100%;
    margin-left:0;
    margin-right:0;
    padding:0 4px;
    align-self:stretch;
  }
  #entries.centered{
    max-width:100%;
  }
}

@media (max-width: 600px){
  header{ padding:0 16px; }
  .header-inner{ max-width:100%; }
  .header-left h1{ font-size:16px; }
  .header-right{
    gap:6px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .header-btn{
    padding:6px 10px;
    font-size:12px;
    min-height:40px;
  }
  .burger-btn{ min-width:40px; min-height:40px; }
  .menu{
    width:min(90vw, 320px);
  }
  .menu{ left:16px; }
  main{ padding-left:16px; padding-right:16px; }
  .search-wrapper,
  .popular-searches,
  .wod-row{ max-width:100%; }
  .wod-row{
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:20px;
    --home-card-width:100%;
  }
  .wod-pill{ min-width:0; width:auto; }
  .trivia-toggle{
    font-size:12px;
    padding:4px 0;
  }
  .wod-title{ font-size:36px; }
  .entry h2{ font-size:24px; }
  .definition{ font-size:14px; }
  #entries:not(.centered):not(:empty){
    padding:10px 12px;
  }
  .example{
    padding:8px 10px;
  }
  .wod-card,
  .trivia-card{
    box-shadow:0 8px 18px rgba(0,0,0,.1);
  }
}
.search-wrapper select option{ text-align:center; color:#000; }

.search-field{
  position:relative;
  flex:1 1 auto;
  min-width:0;
  display:flex;
  align-items:center;
  height:100%;
  align-self:stretch;
}
.search-wrapper input{
  flex:1 1 auto;
  min-width:0;
  border:none;
  padding:20px 48px 20px 18px;
  font-size:17px;
  font-weight:500;
  color:var(--ink);
}
.search-wrapper input::placeholder{ color:#9CA3AF; font-weight:500; font-size:16px; }
.search-wrapper input:focus{outline:none;box-shadow:none;}

.search-wrapper > button{
  border-left:1px solid var(--rule); /* vertical divider before icon */

  position:relative;
  border:none;
  background:none;
  padding:0 16px;
  cursor:pointer;
  color:var(--secondary);
  border-radius:10px;
  min-height:44px;
  transition:background .12s ease, color .12s ease;
}
.search-wrapper > button:hover{
  background:var(--hover);
  color:var(--ink);
}
.clear-btn{
  position:absolute;
  right:12px;
  top:50%;
  transform:translateY(-50%);
  border:none;
  background:transparent;
  color:#9CA3AF;
  padding:4px 6px;
  border-radius:999px;
  cursor:pointer;
  display:none;
  z-index:2;
  min-height:32px;
  transition:background .12s ease, color .12s ease;
}
.clear-btn:hover{ color:var(--ink); background:var(--hover); }
.search-wrapper > button::after{
  content:attr(data-tooltip);
  position:absolute;
  bottom:-36px;
  right:8px;
  background:#111827;
  color:#fff;
  font-size:12px;
  padding:6px 8px;
  border-radius:6px;
  white-space:nowrap;
  opacity:0;
  pointer-events:none;
  transform:translateY(-4px);
  transition:opacity .15s ease, transform .15s ease;
}
.search-wrapper > button:hover::after{
  opacity:1;
  transform:translateY(0);
}
.search-wrapper > button:hover{color:var(--ink);}

/* Suggestions dropdown */
.suggestions{
  position:absolute;
  top:100%;
  left:0;
  width:100%;
  background:#fff;
  border-radius:0 0 var(--radius-md) var(--radius-md);
  box-shadow:0 16px 40px rgba(0,0,0,.18);
  border:1px solid var(--rule);
  border-top:none;
  display:none;
  z-index:500;
  overflow:hidden;
}
.suggestions.open{
  display:grid;
  grid-template-columns:auto 1fr; /* first column matches dropdown width */
}
.suggestions .sugg-side{
  background:rgba(91,111,142,.12);
  color:var(--secondary);
  font-weight:700; /* bolder */
  font-size:13px;  /* slightly bigger */
  padding:14px 12px;
  border-right:1px solid var(--rule);
  text-align:center;
  display:flex;
  align-items:center;
  justify-content:center;
  white-space:nowrap;
}
.suggestions .sugg-list{ padding:6px 0; }
.suggestions .sugg-item{
  padding:12px 14px;
  padding-left:18px; /* align with search input text */
  cursor:pointer;
  font-size:14.5px;
  border-top:1px solid rgba(230,232,235,.7);
}
.suggestions .sugg-item:first-child{
  border-top:none;
}
.suggestions .sugg-item:hover{background:var(--hover);}
.suggestions .sugg-item:active{background:#e1e6eb;}

.entry{
  position:relative;
  margin:0;
  padding:16px 0; /* slightly tighter vertical spacing */
}
.entry:hover{
  background:rgba(0,0,0,.02);
}
.entry{
  animation:entryFade .2s ease;
}
.section-divider{
  width:100%;
  max-width:1020px;
  height:1px;
  background:var(--rule);
  margin:4px auto 16px;
  display:none;
}
.section-divider.is-visible{
  display:block;
}
@keyframes entryFade{
  from{opacity:0;transform:translateY(6px);}
  to{opacity:1;transform:translateY(0);}
}
@keyframes riseIn{
  from{opacity:0;transform:translateY(12px);}
  to{opacity:1;transform:translateY(0);}
}
.wod-row{
  animation:riseIn .35s ease;
}
.sense-block{
  margin-top:12px;
  padding-top:12px;
  border-top:1px solid rgba(230,232,235,.7);
}
.sense-block:first-child{
  margin-top:0;
  padding-top:0;
  border-top:none;
}
.entry::after{
  content:"";
  position:absolute;
  left:0;
  right:-2vw; /* reduced extension to the right */
  bottom:0;
  height:1px;
  background:var(--rule);
}

/* Centered no-match separator */
.entry.no-match::after{
  left:50%;
  right:auto;
  width:60%; /* centered line width */
  transform:translateX(-50%);
}
.headword{display:flex;align-items:baseline;gap:8px;margin-bottom:4px;}
.pron{
  display:flex;
  align-items:center;
  gap:10px;
  margin:2px 0 10px;
  color:var(--secondary);
  font-size:14px;
}
.pron .ipa{
  font-style:normal; /* NOT italic */
  font-weight:500;
  color:var(--ink);
}
/* removed: IPA should not be italic */
.pron button{
  border:none;
  background:transparent;
  cursor:pointer;
  padding:4px 6px;
  border-radius:999px;
}
.pron button:hover{background:var(--hover);}
.pron button.audio-unavailable{
  color:#be123c;
}
.dialect,
.derivs,
.inflections{
  margin:0 0 8px;
  font-size:13.5px;
  line-height:1.45;
}

/* Dialect: special highlighted style */
.dialect{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  background:rgba(91,111,142,.18);
  color:var(--accent);
  font-weight:600;
  margin-bottom:8px;
}

/* Derivatives / inflections: softer, italic */
.derivs,
.inflections{
  color:var(--secondary);
}

.derivs .value{
  font-style:italic;
  font-weight:500;
}
.dialect .label,
.derivs .label,
.inflections .label{
  font-weight:600;
  color:var(--secondary);
}
.dialect .value{
  font-style:normal; /* dialect NOT italic */
  font-weight:600;
  color:var(--accent);
}

.derivs .value,
.inflections .value{
  font-style:italic; /* only inflections/derivatives italic */
  font-weight:500;
  color:var(--secondary);
}
.derivs,
.inflections{margin-bottom:10px;}
.entry h2{
  margin:0;
  color:var(--accent);
  font-size:28px;
  font-weight:600;
  line-height:1.15;
}
.pos{font-style:italic;color:var(--secondary);font-size:14px;}
.definition{font-size:15px;line-height:1.6;}
.definition + .example{ margin-top:10px; }
.equivalent{color:var(--accent-soft);font-weight:500;}
.equivalent .equiv-link{color:inherit;text-decoration:none;font-weight:600;}
.gloss-link{color:inherit;text-decoration:none;font-weight:600;}
.gloss-link:hover{text-decoration:none;}
.gloss-link:focus{outline:2px solid rgba(0,31,61,.35);outline-offset:2px;border-radius:6px;}
.equivalent .equiv-link:hover{text-decoration:none;}
.equivalent .equiv-link:focus{outline:2px solid rgba(0,31,61,.35);outline-offset:2px;border-radius:6px;}

.no-match{
  text-align:center;
}
.no-match .definition{
  font-weight:600;
  font-size:16px;
  margin:0 auto;
}
.no-match .suggestions-title{
  margin-top:10px;
  font-size:13px;
  color:var(--secondary);
}
.no-match .suggestions-list{
  margin:8px 0 0;
  padding:0;
  list-style:none;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  justify-content:center;
}
.no-match .suggestions-list a{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:6px 12px;
  border-radius:999px;
  background:var(--hover);
  color:var(--ink);
  text-decoration:none;
  font-weight:600;
  font-size:13px;
}
.no-match .suggestions-list a:hover{
  background:#e7ebef;
}
.example{
  margin:8px 0;
  padding:10px 12px;
  background:var(--hover);
  border-left:4px solid var(--accent-soft);
  font-size:14px;
  line-height:1.45;
}

.notice{
  background:#fff;
  border:1px solid var(--rule);
  border-radius:var(--radius-md);
  padding:14px 16px;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
  font-size:14px;
  color:var(--secondary);
}
.notice.loading{
  display:none;
  max-width:1020px;
  margin:8px auto 0;
  text-align:center;
}

/* Word of the Day layout */
.wod-row{
  width:100%;
  max-width:800px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  --home-card-width:420px;
  gap:10px;
  margin:32px auto 30px; /* match header-to-search spacing */
}

/* Trivia card */
.trivia-card{
  width:min(100%, calc(var(--home-card-width) - 20px));
  align-self:center;
  background:linear-gradient(160deg, #ffffff 0%, #f2f5f8 100%);
  max-width:100%;
  grid-area:trivia;
  border-radius:var(--radius-lg);
  padding:14px 16px 12px;
  box-shadow:0 14px 30px rgba(13,27,42,.12);
  border:1px solid rgba(13,27,42,.08);
  display:flex;
  flex-direction:column;
  gap:12px;
  position:relative;
  overflow:hidden;
  transition:transform .2s ease, box-shadow .2s ease;
}
.trivia-card:hover{
  transform:translateY(-2px);
  box-shadow:0 18px 36px rgba(13,27,42,.14);
}
.recent-card{
  width:min(100%, var(--home-card-width));
  align-self:center;
  background:#fff;
  border-radius:var(--radius-lg);
  padding:14px;
  box-shadow:0 10px 24px rgba(0,0,0,.08);
  border:1px solid rgba(13,27,42,.08);
  display:flex;
  flex-direction:column;
  gap:10px;
}
.recent-title{
  font-weight:700;
  color:var(--accent);
  font-size:14px;
  text-transform:uppercase;
  letter-spacing:.6px;
}
.recent-list{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.recent-item{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
  padding:8px 10px;
  border-radius:12px;
  background:#f4f6f8;
  cursor:pointer;
}
.recent-meta{
  font-size:12px;
  color:var(--secondary);
  white-space:nowrap;
  margin-top:2px;
}
.recent-item:hover{ background:#ecf0f4; }
.recent-word{
  font-weight:700;
  color:var(--accent);
  font-size:14px;
}
.recent-gloss{
  color:var(--secondary);
  font-size:12.5px;
  margin-top:2px;
}
.trivia-card.is-collapsed .trivia-text{
  max-height:160px;
  overflow:hidden;
}
.trivia-card.is-expanded .trivia-text{
  max-height:none;
}
.trivia-card::before{
  content:"";
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:6px;
  background:linear-gradient(90deg, #0a2540, #0d1b2a);
}
.trivia-title{
  font-weight:700;
  color:var(--accent);
  font-size:15px;
  text-transform:uppercase;
  letter-spacing:.8px;
  margin-top:4px;
}
.trivia-text{
  color:var(--ink);
  font-size:13.5px;
  line-height:1.5;
}
.trivia-toggle{
  align-self:flex-start;
  border:none;
  background:transparent;
  color:var(--accent);
  font-weight:600;
  font-size:12.5px;
  padding:0;
  cursor:pointer;
}
.trivia-toggle:hover{ text-decoration:underline; }
.trivia-photo{
  width:100%;
  border-radius:var(--radius-md);
  border:1px solid rgba(13,27,42,.1);
  object-fit:cover;
  max-height:180px;
}

/* Word of the Day card (Oxford-like) */
.wod-card{
  width:min(100%, calc(var(--home-card-width) + 40px));
  align-self:center;
  max-width:100%;
  grid-area:wod;
  background:rgba(91,111,142,.16);
  border-radius:var(--radius-lg);
  padding:16px 38px 14px;
  margin:0 auto;
  text-align:center;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
  box-shadow:0 12px 28px rgba(0,0,0,.12);
  border:1px solid rgba(255,255,255,.65);
  transition:transform .2s ease, box-shadow .2s ease;
}
.wod-card:hover{
  transform:translateY(-2px);
  box-shadow:0 16px 32px rgba(0,0,0,.14);
}
.wod-top{
  display:flex;
  align-items:center;
  justify-content:center; /* center date */
  color:rgba(13,27,42,.72);
  font-size:14px;
  font-weight:500;
  position:relative;
  margin:0;
}

.wod-title{
  margin:0;
  font-size:40px; /* larger Word of the Day */
  font-weight:700;
  color:var(--accent);
  line-height:1.05;
}
.wod-pos{
  display:block;
  font-style:italic;
  color:rgba(13,27,42,.72);
  margin:0;
  font-size:13px; /* smaller POS */
}
.wod-actions{
  display:flex;
  align-items:center;
  justify-content:center; /* center single audio icon */
  margin:0;
}
.wod-actions button{
  border:none;
  background:transparent;
  cursor:pointer;
  padding:8px;
  border-radius:999px;
  position:relative;
}
.wod-actions button:hover{ background:rgba(255,255,255,.55); }

/* Listen tooltip */
.wod-actions button::after{
  content:attr(data-tooltip);
  position:absolute;
  bottom:-34px;
  left:50%;
  transform:translateX(-50%) translateY(-4px);
  background:#111827;
  color:#fff;
  font-size:12px;
  padding:6px 8px;
  border-radius:6px;
  white-space:nowrap;
  opacity:0;
  pointer-events:none;
  transition:opacity .15s ease, transform .15s ease;
}
.wod-actions button:hover::after{
  opacity:1;
  transform:translateX(-50%) translateY(0);
}

/* Disabled state */
.wod-actions button:disabled{
  opacity:1;
  cursor:pointer;
  color:#be123c;
}
.wod-actions button:disabled:hover{ background:transparent; }
.wod-actions button:disabled::after{ opacity:0; }
.wod-actions button.audio-unavailable{
  color:#be123c;
}
.wod-actions .wod-a2{ color:#BE123C; font-size:22px; }
.wod-sub{
  color:rgba(13,27,42,.72);
  font-size:13px;
  margin:6px 0 10px;
}
.wod-pill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:10px 14px;
  border-radius:999px;
  background:rgba(13,27,42,.12);
  color:var(--accent);
  font-weight:600;
  letter-spacing:.3px;
  font-size:12px;
  max-width:100%;
  text-align:center;
  padding-left:12px;
  padding-right:12px;
  white-space:nowrap;
}
.wod-level{
  display:inline-block;
  margin-top:10px;
  padding:4px 8px;
  border-radius:var(--radius-sm);
  background:rgba(17,24,39,.18);
  color:rgba(13,27,42,.9);
  font-weight:700;
  font-size:12px;
}
.wod-foot{
  margin-top:12px;
  font-size:11px;
  color:rgba(13,27,42,.65);
}

.wod-link{
  color:var(--accent);
  text-decoration:none;
  font-weight:700;
}
.wod-link:hover{ text-decoration:none; }

.wod-meaning{
  margin:0;
  display:none; /* keep Oxford-like card clean; word opens entry on click */
}

.wod-link{
  color:var(--accent);
  text-decoration:none;
  font-weight:600;
}
.wod-link:hover{ text-decoration:none; }

footer{
  margin-top:auto;
  padding:18px 5vw calc(18px + env(safe-area-inset-bottom));
  text-align:center;
  font-size:11px;
  color:rgba(75,85,99,.75);
  border-top:1px solid var(--rule);
  position:fixed;
  left:0;
  right:0;
  bottom:0;
  background:var(--paper);
  z-index:900;
}

@media (max-height: 600px){
  footer{
    position:fixed;
    left:0;
    right:0;
    bottom:0;
    background:var(--paper);
    z-index:900;
  }
  main{
    padding-bottom:80px;
  }
}

@media (max-width: 600px){
  footer{
    position:static;
  }
  main{
    padding-bottom:32px;
  }
}

/* Submit modal */
.modal-backdrop{
  position:fixed;
  inset:0;
  background:hsla(211, 53%, 11%, 0.45);
  display:none;
  align-items:center;
  justify-content:center;
  padding:24px 5vw;
  z-index:2000;
}
.modal-backdrop.open{display:flex;}
.modal-card{
  width:min(720px, 100%);
  background:#fff;
  border-radius:var(--radius-lg);
  box-shadow:0 20px 50px rgba(0,0,0,.28);
  border:1px solid var(--rule);
  padding:18px;
  max-height:calc(100vh - 80px);
  overflow:auto;
}
.modal-card .modal-head{
  padding-bottom:6px;
  border-bottom:1px solid rgba(230,232,235,.7);
}
.modal-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:12px;
}
.modal-title{
  font-weight:700;
  color:var(--accent);
  font-size:18px;
}
.modal-close{
  border:none;
  background:var(--hover);
  color:var(--ink);
  border-radius:var(--radius-sm);
  padding:8px 10px;
  cursor:pointer;
  transition:transform .12s ease, background .12s ease;
}
.modal-close:hover{background:#e9edf1;}
.submit-grid{
  display:grid;
  gap:12px;
  grid-template-columns:1fr 1fr;
}
.submit-grid .full{grid-column:1 / -1;}
.submit-grid label{
  display:block;
  font-size:12.5px;
  color:var(--secondary);
  font-weight:600;
  margin-bottom:6px;
  text-transform:uppercase;
  letter-spacing:.5px;
}
.submit-grid input,
.submit-grid select,
.submit-grid textarea{
  width:100%;
  border:1px solid var(--rule);
  border-radius:var(--radius-md);
  padding:10px 12px;
  font-family:inherit;
  font-size:16px;
  color:var(--ink);
  background:#fbfcfd;
  transition:border-color .12s ease, box-shadow .12s ease;
}
.submit-grid input:focus,
.submit-grid select:focus,
.submit-grid textarea:focus{
  border-color:rgba(13,27,42,.3);
  box-shadow:0 0 0 3px rgba(13,27,42,.08);
}
.submit-grid textarea{min-height:110px;resize:vertical;}
.submit-actions{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-top:12px;
}
.submit-actions > div{
  display:flex;
  gap:8px;
}
.submit-actions .note{
  font-size:12px;
  color:var(--secondary);
}
.submit-actions button{
  border:none;
  border-radius:16px;
  padding:12px 20px;
  font-weight:600;
  cursor:pointer;
  transition:transform .12s ease, box-shadow .12s ease;
}
.btn-secondary{
  background:#eef1f4;
  color:var(--ink);
  border:1px solid #e0e6ec;
}
.btn-primary{
  background:var(--accent);
  color:#fff;
  box-shadow:var(--btn-shadow);
}
.btn-primary:hover{background:#0b274b;}
.btn-primary:hover,
.btn-secondary:hover,
.modal-close:hover{
  transform:translateY(-1px);
}
.btn-primary:active,
.btn-secondary:active,
.modal-close:active{
  transform:translateY(0);
}

@media (max-width: 640px){
  .submit-grid{grid-template-columns:1fr;}
  .contact-grid{grid-template-columns:1fr;}
  .submit-actions,
  .contact-actions{
    flex-direction:column;
    align-items:flex-start;
  }
  .submit-actions button,
  .contact-actions button{
    width:100%;
  }
  .submit-grid input,
  .submit-grid select,
  .submit-grid textarea,
  .contact-grid input,
  .contact-grid textarea{
    font-size:16px;
  }
  .donate-options{
    flex-direction:column;
    align-items:stretch;
  }
  .donate-option{
    width:100%;
    text-align:center;
  }
}


/* Contact modal */
.contact-card .modal-title{ font-size:17px; }
.contact-grid{
  display:grid;
  gap:12px;
  grid-template-columns:1fr 1fr;
}
.contact-grid .full{grid-column:1 / -1;}
.contact-grid label{
  display:block;
  font-size:12.5px;
  color:var(--secondary);
  font-weight:600;
  margin-bottom:6px;
  text-transform:uppercase;
  letter-spacing:.5px;
}
.contact-grid input,
.contact-grid textarea{
  width:100%;
  border:1px solid var(--rule);
  border-radius:var(--radius-md);
  padding:10px 12px;
  font-family:inherit;
  font-size:16px;
  color:var(--ink);
  background:#fbfcfd;
  transition:border-color .12s ease, box-shadow .12s ease;
}
.contact-grid input:focus,
.contact-grid textarea:focus{
  border-color:rgba(13,27,42,.3);
  box-shadow:0 0 0 3px rgba(13,27,42,.08);
}
.contact-grid textarea{min-height:160px;resize:vertical;}
.contact-actions{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-top:12px;
}
.contact-actions > div{
  display:flex;
  gap:8px;
}
.contact-actions .note{
  font-size:12px;
  color:var(--secondary);
}
.contact-actions button{
  border:none;
  border-radius:16px;
  padding:12px 20px;
  font-weight:600;
  cursor:pointer;
  transition:transform .12s ease, box-shadow .12s ease;
}

/* Donate modal */
.donate-card .modal-title{ font-size:17px; }
.donate-options{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin:6px 0 14px;
}
.donate-option{
  border:1px solid var(--rule);
  background:var(--hover);
  color:var(--ink);
  border-radius:999px;
  padding:8px 14px;
  font-weight:600;
  cursor:pointer;
  transition:transform .12s ease, background .12s ease, color .12s ease;
}
.donate-option.active{
  background:var(--accent);
  color:#fff;
  border-color:var(--accent);
}
.donate-option:hover{
  transform:translateY(-1px);
}
.donate-qr{
  display:flex;
  align-items:center;
  justify-content:center;
  background:#fff;
  border:1px solid var(--rule);
  border-radius:var(--radius-lg);
  padding:16px;
  min-height:180px;
}
.donate-qr img{
  max-width:260px;
  width:100%;
  height:auto;
  border-radius:var(--radius-sm);
}

@media (prefers-reduced-motion: reduce){
  .entry,
  .wod-row{
    animation:none;
  }
  .wod-card,
  .trivia-card,
  .search-wrapper{
    transition:none;
  }
}
.donate-details{
  text-align:center;
  font-weight:700;
  color:var(--accent);
  font-size:18px;
  line-height:1.4;
  user-select:text;
}
.donate-line{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  margin:2px 0;
  user-select:text;
}
.copy-btn{
  border:none;
  background:rgba(13,27,42,.08);
  color:var(--accent);
  border-radius:999px;
  padding:4px 8px;
  font-size:11px;
  font-weight:600;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:4px;
  line-height:1;
  position:relative;
}
.copy-btn:hover{ background:rgba(13,27,42,.14); }
.copy-btn:active{ transform:translateY(1px); }
.copy-btn::after{
  content:attr(data-tooltip);
  position:absolute;
  bottom:calc(100% + 6px);
  left:50%;
  transform:translateX(-50%);
  background:#111827;
  color:#fff;
  font-size:11px;
  padding:4px 6px;
  border-radius:6px;
  opacity:0;
  pointer-events:none;
  white-space:nowrap;
  transition:opacity .12s ease;
}
.copy-btn:hover::after{
  opacity:1;
}
.donate-sub{
  display:block;
  font-weight:600;
  color:var(--secondary);
  font-size:13px;
  margin-top:6px;
}
.donate-note{
  margin-top:10px;
  font-size:12px;
  color:var(--secondary);
  text-align:center;
}


/* Remove blue autofill background */
input:-webkit-autofill,
input:-webkit-autofill:hover,
input:-webkit-autofill:focus,
input:-webkit-autofill:active {
  -webkit-box-shadow:0 0 0px 1000px #fff inset !important;
  -webkit-text-fill-color:var(--ink) !important;
  transition:background-color 5000s ease-in-out 0s;
}


</style>
</head>

<body>
<a class="skip-link" href="#search">Skip to search</a>
<header>
  <div class="header-inner">
    <div class="header-left">
      <button class="burger-btn" id="burger" type="button" aria-label="Open menu" aria-haspopup="true" aria-expanded="false">
        <i class="fa-solid fa-bars"></i>
      </button>
    <h1><a href="#/" class="site-title" id="homeLink">Bikol Dictionary</a></h1>
    </div>

    <div class="header-right">
      <button class="header-btn submit-btn" id="submitBtn" type="button" aria-label="Submit">
        <i class="fa-solid fa-paper-plane"></i>
        Submit
      </button>
      <button class="header-btn donate-btn" id="donateBtn" type="button" aria-label="Donate">
        <i class="fa-solid fa-hand-holding-heart"></i>
        Donate
      </button>
    </div>
  </div>
</header>

<nav class="menu" id="menu" aria-label="Site menu">
  <a href="#about">About</a>
  <a href="#grammar">Grammar</a>
  <a href="#resources">Resources</a>
  <a href="#contact" id="contactLink">Contact</a>
  <a href="#donate" id="donateLink">Donate</a>
</nav>

<main>
  <div class="search-wrapper">
    <select id="lang">
      <option value="english" data-short="English" data-long="English – Bikol">English</option>
      <option value="bikol" data-short="Bikol" data-long="Bikol – English" selected>Bikol</option>
    </select>
    <div class="search-field">
    <input id="search" placeholder="Search Bikol - English Dictionary" autocomplete="off" />
      <button class="clear-btn" id="clearBtn" type="button" aria-label="Clear search">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <button id="searchBtn" type="button" aria-label="Search" data-tooltip="Search"><i class="fa-solid fa-magnifying-glass"></i></button>
    <div class="suggestions" id="suggestions"></div>
  </div>

  <div class="wod-row" id="wodRow">
    <div class="wod-card" id="wordOfDay" role="region" aria-label="Word of the Day">
      <div class="wod-top">
        <div id="wod-date">—</div>
      </div>

      <div class="wod-title"><span id="wod-word">—</span></div>
      <span class="wod-pos" id="wod-pos"></span>

      <div class="wod-actions">
        <button type="button" id="wodListenBtn" class="wod-listen" aria-label="Listen" data-tooltip="Listen">
          <i class="fa-solid fa-volume-high wod-a2"></i>
        </button>
      </div>

      <div class="wod-pill" id="wod-list">Bikol Word of the Day</div>
      <div class="wod-level" id="wod-level" style="display:none;">A2</div>

      <span class="wod-meaning" id="wod-meaning"></span>
    </div>

    <aside class="trivia-card" id="triviaCard" aria-label="Trivia">
      <div class="trivia-title" id="triviaTitle">DID YOU KNOW?</div>
      <div class="trivia-text" id="triviaText"></div>
      <button class="trivia-toggle" id="triviaToggle" type="button">See more...</button>
      <img class="trivia-photo" id="triviaPhoto" alt="" loading="lazy" decoding="async" style="display:none;" />
    </aside>

    <aside class="recent-card" id="recentCard" aria-label="Recently added">
      <div class="recent-title">Recently Added</div>
      <div class="recent-list" id="recentList"></div>
    </aside>
  </div>

  <div class="section-divider" id="sectionDivider" aria-hidden="true"></div>
  <div class="notice loading" id="loadingNotice">Loading dictionary…</div>
  <div id="entries"></div>
</main>

<footer>© 2026 Jusan Misolas. All rights reserved.</footer>

<div class="modal-backdrop" id="submitModal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="submitTitle">
    <div class="modal-head">
      <div class="modal-title" id="submitTitle">Contribute a Bikol Word</div>
      <button class="modal-close" type="button" id="submitClose" aria-label="Close form">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <form id="submitForm">
      <div class="submit-grid">
        <div>
          <label for="subWord">Bikol Word</label>
          <input id="subWord" name="word" required />
        </div>
        <div>
          <label for="subPos">Part of Speech</label>
          <select id="subPos" name="pos" required>
            <option value="">Select</option>
            <option>bound root</option>
            <option>free root</option>
            <option>noun</option>
            <option>verb</option>
            <option>adjective</option>
            <option>adverb</option>
            <option>pronoun</option>
            <option>preposition</option>
            <option>conjunction</option>
            <option>interjection</option>
            <option>others</option>
          </select>
        </div>
        <div id="subPosOtherWrap" style="display:none;">
          <label for="subPosOther">Other (specify)</label>
          <input id="subPosOther" name="pos_other" />
        </div>
        <div class="full">
          <label for="subMeaning">Meaning(s)</label>
          <textarea id="subMeaning" name="meaning" required></textarea>
        </div>
        <div class="full">
          <label for="subExample">Example Sentences</label>
          <textarea id="subExample" name="example" required placeholder="Bikol sentence || English translation"></textarea>
        </div>
        <div>
          <label for="subDialect">Dialect/Language</label>
          <input id="subDialect" name="dialect" required />
        </div>
        <div>
          <label for="subDerivs">Derivatives</label>
          <input id="subDerivs" name="derivatives" required />
        </div>
        <div>
          <label for="subInflections">Inflections</label>
          <input id="subInflections" name="inflections" required />
        </div>
        <div class="full">
          <label for="subName">Your Name (for Credits)</label>
          <input id="subName" name="name" required />
        </div>
      </div>

      <div class="submit-actions">
        <div class="note">Submitting opens your email client to send the entry for review.</div>
        <div>
          <button class="btn-secondary" type="button" id="submitCancel">Cancel</button>
          <button class="btn-primary" type="submit">Send submission</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="modal-backdrop" id="contactModal" aria-hidden="true">
  <div class="modal-card contact-card" role="dialog" aria-modal="true" aria-labelledby="contactTitle">
    <div class="modal-head">
      <div class="modal-title" id="contactTitle">Contact Site Admin</div>
      <button class="modal-close" type="button" id="contactClose" aria-label="Close contact form">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <form id="contactForm">
      <div class="contact-grid">
        <div>
          <label for="contactName">Your Name</label>
          <input id="contactName" name="name" required />
        </div>
        <div>
          <label for="contactEmail">Your Email</label>
          <input id="contactEmail" name="email" type="email" required />
        </div>
        <div class="full">
          <label for="contactSubject">Subject</label>
          <input id="contactSubject" name="subject" required />
        </div>
        <div class="full">
          <label for="contactMessage">Message</label>
          <textarea id="contactMessage" name="message" required></textarea>
        </div>
      </div>

      <div class="contact-actions">
        <div class="note">This opens your email client to send the message.</div>
        <div>
          <button class="btn-secondary" type="button" id="contactCancel">Cancel</button>
          <button class="btn-primary" type="submit">Send message</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="modal-backdrop" id="donateModal" aria-hidden="true">
  <div class="modal-card donate-card" role="dialog" aria-modal="true" aria-labelledby="donateTitle">
    <div class="modal-head">
      <div class="modal-title" id="donateTitle">Support the Bikol Dictionary</div>
      <button class="modal-close" type="button" id="donateClose" aria-label="Close donate options">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <div class="donate-options" role="tablist" aria-label="Donation methods">
      <button class="donate-option active" type="button" data-method="paypal" role="tab" aria-selected="true">PayPal</button>
      <button class="donate-option" type="button" data-method="gcash" role="tab" aria-selected="false">GCash</button>
      <button class="donate-option" type="button" data-method="maya" role="tab" aria-selected="false">Maya</button>
      <button class="donate-option" type="button" data-method="bpi" role="tab" aria-selected="false">BPI</button>
    </div>

    <div class="donate-qr" id="donateQr">
      <div class="donate-details" id="donateDetails"></div>
    </div>
    <div class="donate-note" id="donateNote">Donation details shown per method.</div>
  </div>
</div>

<!--
Fallback sample (ONLY used if english_to_bikol.csv cannot be fetched in a sandboxed preview).
Keep your real database in: english_to_bikol.csv
-->
<script type="text/plain" id="csv-fallback">english,pos,sense1_meaning,sense1_bikol,sense1_example,sense2_meaning,sense2_bikol,sense2_example,sense3_meaning,sense3_bikol,sense3_example,sense4_meaning,sense4_bikol,sense4_example,sense5_meaning,sense5_bikol,sense5_example,sense6_meaning,sense6_bikol,sense6_example,sense7_meaning,sense7_bikol,sense7_example,sense8_meaning,sense8_bikol,sense8_example,sense9_meaning,sense9_bikol,sense9_example,sense10_meaning,sense10_bikol,sense10_example
run,verb,to move swiftly on foot,dalagan,May nahiling akong nagdadalagan na ikos.||I saw a cat running.,to manage or operate something,padalagan,Matibay syang magpadalagan nin negosyo.||She is good at running business.,,,,,,,,,,,,,,,,,,,,,,,,
house,noun,a building for people to live in,harong,Ini an samuyang harong.||This is our house.,,,,,,,,,,,,,,,,,,,,,,,,,,,
eat,verb,to put food into the mouth and swallow,kakan,Nagkakan kami subagong aga.||We ate this morning.,,,,,,,,,,,,,,,,,,,,,,,,,,,
big,adjective,of large size,dakula,Dakula an harong.||The house is big.,,,,,,,,,,,,,,,,,,,,,,,,,,,
</script>

<!-- Optional fallback for bikol_to_english.csv (used only when CSV fetch is blocked) -->
<script type="text/plain" id="csv-fallback-bi">bikol,pos,ipa,audio_url,dialect,derivatives_inflections,wod,featured,sense1_gloss,sense1_meaning,sense1_example,sense2_gloss,sense2_meaning,sense2_example,sense3_gloss,sense3_meaning,sense3_example,sense4_gloss,sense4_meaning,sense4_example,sense5_gloss,sense5_meaning,sense5_example,sense6_gloss,sense6_meaning,sense6_example,sense7_gloss,sense7_meaning,sense7_example,sense8_gloss,sense8_meaning,sense8_example,sense9_gloss,sense9_meaning,sense9_example,sense10_gloss,sense10_meaning,sense10_example
kakan,verb,kakán,,Naga Bikol,"kakan, nagkakan, magkakan",yes,,eat,to put food into the mouth and swallow,Nagkakan kami subagong aga.||We ate this morning.,,,,,,,,,,,,,,,,,,,,,,,,,,,
dalagan,verb,dalágan,,,"dalagan, nagdadalagan, magdalagan",,,run,to move swiftly on foot,May nahiling akong nagdadalagan na ikos.||I saw a cat running.,operate,to manage or operate something,Matibay siyang magpadalagan nin negosyo.||She runs a business.,,,,,,,,,,,,,,,,,,,,,,,,
harong,noun,haróng,,,,,house,a building for people to live in,Ini an samuyang harong.||This is our house.,,,,,,,,,,,,,,,,,,,,,,,,,,,
dakula,adjective,dakulâ,,,,,big,of large size,Dakula an harong.||The house is big.,,,,,,,,,,,,,,,,,,,,,,,,,,,
</script>

<script>
// CSV is separate: put english_to_bikol.csv beside this HTML.
// In some previews/sandboxes, file fetch is blocked. If that happens, we fall back to a tiny sample.

let dictionaryEN = [];
let dictionaryBI = [];
let dataReady = false; // set true after CSV loads
let pendingRoute = null; // holds parsed hash until data is ready

const burger = document.getElementById("burger");
const menu = document.getElementById("menu");
const search = document.getElementById("search");
const suggestions = document.getElementById("suggestions");
const entries = document.getElementById("entries");
const lang = document.getElementById("lang");
const searchBtn = document.getElementById("searchBtn");
const clearBtn = document.getElementById("clearBtn");
const sectionDivider = document.getElementById("sectionDivider");
const loadingNotice = document.getElementById("loadingNotice");

const wordOfDay = document.getElementById("wordOfDay");
const wodDate = document.getElementById("wod-date");
const wodWord = document.getElementById("wod-word");
const wodPos = document.getElementById("wod-pos");
const wodList = document.getElementById("wod-list");
const wodLevel = document.getElementById("wod-level");
const wodMeaning = document.getElementById("wod-meaning");
const wodListenBtn = document.getElementById("wodListenBtn");
const wodRow = document.getElementById("wodRow");
const triviaCard = document.getElementById("triviaCard");
const triviaTitle = document.getElementById("triviaTitle");
const triviaText = document.getElementById("triviaText");
const triviaPhoto = document.getElementById("triviaPhoto");
const triviaToggle = document.getElementById("triviaToggle");
const recentCard = document.getElementById("recentCard");
const recentList = document.getElementById("recentList");
const submitBtn = document.getElementById("submitBtn");
const submitModal = document.getElementById("submitModal");
const submitClose = document.getElementById("submitClose");
const submitCancel = document.getElementById("submitCancel");
const submitForm = document.getElementById("submitForm");
const subPos = document.getElementById("subPos");
const subPosOtherWrap = document.getElementById("subPosOtherWrap");
const subPosOther = document.getElementById("subPosOther");
const contactLink = document.getElementById("contactLink");
const contactModal = document.getElementById("contactModal");
const contactClose = document.getElementById("contactClose");
const contactCancel = document.getElementById("contactCancel");
const contactForm = document.getElementById("contactForm");
const donateLink = document.getElementById("donateLink");
const donateBtn = document.getElementById("donateBtn");
const donateModal = document.getElementById("donateModal");
const donateClose = document.getElementById("donateClose");
const donateDetails = document.getElementById("donateDetails");
const donateNote = document.getElementById("donateNote");
const donateOptions = Array.from(document.querySelectorAll(".donate-option"));

let currentWod = null;
let wodAudio = null; // HTMLAudioElement when an audio URL is provided
let triviaItems = [];
let triviaExpanded = false;
let isUserTyping = false;
const fallbackTrivia = [
  {
    text: "The Bikol Region is known for its active volcanoes, including Mayon Volcano, famous for its near-perfect cone.",
    image: ""
  }
];

// Hash routing: #/english/<term> or #/bikol/<term>
let currentRouteKey = "";

function buildRouteKey(mode, term){
  return String(mode || "") + "|" + String(term || "").toLowerCase();
}

function parseHashRoute(){
  const h = (window.location.hash || "").replace(/^#/, "");
  if (!h) return null;
  const parts = h.split("/").filter(Boolean); // remove empty
  if (parts.length < 2) return null;
  const mode = (parts[0] || "").toLowerCase();
  const term = decodeURIComponent(parts.slice(1).join("/") || "").trim();
  if (!term) return null;
  if (mode !== "english" && mode !== "bikol") return null;
  return { mode, term };
}

function setHashRoute(mode, term, replace){
  const safeMode = (mode === "bikol") ? "bikol" : "english";
  const safeTerm = String(term || "").trim();
  if (!safeTerm) return;
  const next = "#/" + safeMode + "/" + encodeURIComponent(safeTerm);
  if (replace) {
    history.replaceState(null, "", next);
  } else {
    window.location.hash = next;
  }
}

function clearHashRoute(){
  history.replaceState(null, "", " ");
  // Some browsers keep a trailing space in the URL bar if we leave it as-is.
  history.replaceState(null, "", window.location.pathname + window.location.search);
}

function findExactByMode(mode, term){
  const q = String(term || "").trim().toLowerCase();
  if (!q) return null;

  const dict = (mode === "bikol") ? dictionaryBI : dictionaryEN;
  const field = (mode === "bikol") ? "bikol" : "english";

  return dict.find(row => (row[field] || "").toLowerCase() === q) || null;
}

function applyRouteFromHash(){
  // Wait until CSV is loaded before resolving deep links.
  if (!dataReady) {
    pendingRoute = parseHashRoute();
    return;
  }
  const r = parseHashRoute();
  if (!r) {
    // Home view
    search.value = "";
    entries.innerHTML = "";
    closeSuggestions();
    syncWordOfDayVisibility();
    updateClearButton();
    syncDividerVisibility();
    currentRouteKey = "";
    return;
  }

  const key = buildRouteKey(r.mode, r.term);
  if (key === currentRouteKey) return;

  // Set dropdown (keep short captions)
  lang.value = (r.mode === "bikol") ? "bikol" : "english";
  setLangOptionsShort();

  closeSuggestions();
  search.value = "";
  hideWordOfDay();
  updateClearButton();
  syncDividerVisibility();

  const match = findExactByMode(r.mode, r.term);
  if (match) {
    currentRouteKey = key;
    render(match);
  } else {
    currentRouteKey = key;
    noMatch(r.term);
  }
}

function escapeHtml(str) {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function closeSuggestions(){
  suggestions.classList.remove("open");
  suggestions.innerHTML = "";
}

function positionMenu(){
  if (!menu || !burger) return;
  const rect = burger.getBoundingClientRect();
  const menuWidth = menu.offsetWidth || 220;
  const left = Math.max(12, Math.min(rect.left, window.innerWidth - menuWidth - 12));
  menu.style.left = left + "px";
  menu.style.top = Math.round(rect.bottom + 8) + "px";
}

function updateClearButton(){
  if (!clearBtn) return;
  const hasValue = (search.value || "").trim().length > 0;
  clearBtn.style.display = hasValue ? "inline-flex" : "none";
}

function syncDividerVisibility(){
  if (!sectionDivider) return;
  const hasEntries = (entries.innerHTML || "").trim() !== "";
  sectionDivider.classList.toggle("is-visible", hasEntries);
}


function showLoading(){
  if (!loadingNotice) return;
  loadingNotice.style.display = "block";
}

function hideLoading(){
  if (!loadingNotice) return;
  loadingNotice.style.display = "none";
}

let activeTrap = null;

function activateTrap(modal){
  if (!modal) return;
  releaseTrap();
  const handler = (e) => {
    if (e.key !== "Tab") return;
    const focusable = modal.querySelectorAll(
      'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'
    );
    if (!focusable.length) return;
    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    if (e.shiftKey && document.activeElement === first) {
      e.preventDefault();
      last.focus();
    } else if (!e.shiftKey && document.activeElement === last) {
      e.preventDefault();
      first.focus();
    }
  };
  activeTrap = { modal, handler };
  document.addEventListener("keydown", handler);
}

function releaseTrap(){
  if (!activeTrap) return;
  document.removeEventListener("keydown", activeTrap.handler);
  activeTrap = null;
}

function openSubmitModal(){
  if (!submitModal) return;
  submitModal.classList.add("open");
  submitModal.setAttribute("aria-hidden", "false");
  activateTrap(submitModal);
  const first = document.getElementById("subWord");
  if (first) first.focus();
}

function closeSubmitModal(){
  if (!submitModal) return;
  submitModal.classList.remove("open");
  submitModal.setAttribute("aria-hidden", "true");
  releaseTrap(submitModal);
}

function openContactModal(){
  if (!contactModal) return;
  contactModal.classList.add("open");
  contactModal.setAttribute("aria-hidden", "false");
  activateTrap(contactModal);
  const first = document.getElementById("contactName");
  if (first) first.focus();
}

function closeContactModal(){
  if (!contactModal) return;
  contactModal.classList.remove("open");
  contactModal.setAttribute("aria-hidden", "true");
  releaseTrap(contactModal);
}

function openDonateModal(){
  if (!donateModal) return;
  donateModal.classList.add("open");
  donateModal.setAttribute("aria-hidden", "false");
  activateTrap(donateModal);
  setDonateMethod("paypal");
}

function closeDonateModal(){
  if (!donateModal) return;
  donateModal.classList.remove("open");
  donateModal.setAttribute("aria-hidden", "true");
  releaseTrap(donateModal);
}

const donateLabelMap = {
  paypal: "PayPal",
  gcash: "GCash",
  maya: "Maya",
  bpi: "BPI"
};

function wireCopyButtons(){
  if (!donateDetails) return;
  donateDetails.querySelectorAll(".copy-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const text = btn.getAttribute("data-copy") || "";
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
        btn.innerHTML = '<i class="fa-solid fa-check"></i>';
        setTimeout(() => {
          btn.innerHTML = '<i class="fa-regular fa-copy"></i>';
        }, 1200);
      } catch {
        const temp = document.createElement("textarea");
        temp.value = text;
        temp.setAttribute("readonly", "true");
        temp.style.position = "absolute";
        temp.style.left = "-9999px";
        document.body.appendChild(temp);
        temp.select();
        document.execCommand("copy");
        document.body.removeChild(temp);
        btn.innerHTML = '<i class="fa-solid fa-check"></i>';
        setTimeout(() => {
          btn.innerHTML = '<i class="fa-regular fa-copy"></i>';
        }, 1200);
      }
    });
  });
}

function setDonateMethod(method){
  const key = (method || "").toLowerCase();
  donateOptions.forEach(btn => {
    const active = btn.dataset.method === key;
    btn.classList.toggle("active", active);
    btn.setAttribute("aria-selected", active ? "true" : "false");
  });

  if (!donateDetails) return;
  if (key === "gcash") {
    donateDetails.innerHTML =
      '<span class="donate-line">JUSAN MISOLAS <button class="copy-btn" type="button" data-copy="JUSAN MISOLAS" data-tooltip="Copy" aria-label="Copy name"><i class="fa-regular fa-copy"></i></button></span>' +
      '<span class="donate-line">09293001049 <button class="copy-btn" type="button" data-copy="09293001049" data-tooltip="Copy" aria-label="Copy number"><i class="fa-regular fa-copy"></i></button></span>' +
      '<span class="donate-sub">GCash account</span>';
  } else if (key === "maya") {
    donateDetails.innerHTML =
      '<span class="donate-line">JUSAN MISOLAS <button class="copy-btn" type="button" data-copy="JUSAN MISOLAS" data-tooltip="Copy" aria-label="Copy name"><i class="fa-regular fa-copy"></i></button></span>' +
      '<span class="donate-line">09293001049 <button class="copy-btn" type="button" data-copy="09293001049" data-tooltip="Copy" aria-label="Copy number"><i class="fa-regular fa-copy"></i></button></span>' +
      '<span class="donate-sub">Maya account</span>';
  } else if (key === "paypal") {
    donateDetails.innerHTML =
      '<span class="donate-line">JUSAN MISOLAS <button class="copy-btn" type="button" data-copy="JUSAN MISOLAS" data-tooltip="Copy" aria-label="Copy name"><i class="fa-regular fa-copy"></i></button></span>' +
      '<span class="donate-line">wasuywasuywasuy@gmail.com <button class="copy-btn" type="button" data-copy="wasuywasuywasuy@gmail.com" data-tooltip="Copy" aria-label="Copy email"><i class="fa-regular fa-copy"></i></button></span>' +
      '<span class="donate-sub">PayPal</span>';
  } else if (key === "bpi") {
    donateDetails.innerHTML =
      '<span class="donate-line">JUSAN MISOLAS <button class="copy-btn" type="button" data-copy="JUSAN MISOLAS" data-tooltip="Copy" aria-label="Copy name"><i class="fa-regular fa-copy"></i></button></span>' +
      '<span class="donate-line">8869403009 <button class="copy-btn" type="button" data-copy="8869403009" data-tooltip="Copy" aria-label="Copy number"><i class="fa-regular fa-copy"></i></button></span>' +
      '<span class="donate-sub">Bank of the Philippine Islands</span>';
  } else {
    donateDetails.textContent = (donateLabelMap[key] || "Donation") + " details coming soon.";
  }
  if (donateNote) donateNote.textContent = "Donation details shown per method.";
  wireCopyButtons();
}

function hideWordOfDay(){
  if (wordOfDay) wordOfDay.style.display = "none";
}

function showWordOfDay(){
  if (wordOfDay) wordOfDay.style.display = "";
}

function hideTrivia(){
  if (triviaCard) triviaCard.style.display = "none";
}

function showTrivia(){
  if (triviaCard) triviaCard.style.display = "";
}

function hideRecent(){
  if (recentCard) recentCard.style.display = "none";
}

function showRecent(){
  if (recentCard) recentCard.style.display = "";
}

function hideWodRow(){
  if (wodRow) wodRow.style.display = "none";
}

function showWodRow(){
  if (wodRow) wodRow.style.display = "";
}

function isTruthy(v){
  const s = String(v ?? "").trim().toLowerCase();
  return s === "1" || s === "true" || s === "yes" || s === "y" || s === "wod";
}

function isHomeView(){
  if (isUserTyping) return false;
  const html = (entries.innerHTML || "").trim();
  if (!html) return true;
  return !!entries.querySelector(".notice");
}

function pickWordOfDay(rows){
  // TEMP: force Word of the Day to "kakan" for this chat
  const forced = rows.find(r => (r.bikol || "").toLowerCase() === "kakan");
  if (forced) return forced;

  // MANUAL Word of the Day only (fallback)
  const curated = rows.filter(r =>
    isTruthy(r.wod) || isTruthy(r.word_of_day) || isTruthy(r.wordOfDay) || isTruthy(r.wotd) || isTruthy(r.featured)
  );

  if (!curated.length) return null;

  const dayIndex = Math.floor(Date.now() / 86400000);
  const idx = dayIndex % curated.length;
  return curated[idx];
}

function formatWodDate(d){
  // e.g., 18 January 2026
  try {
    const dt = new Date(d);
    const day = dt.getDate();
    const month = dt.toLocaleString(undefined, { month: "long" });
    const year = dt.getFullYear();
    return day + " " + month + " " + year;
  } catch {
    return "";
  }
}

function setWordOfDay(){
  if (!wordOfDay || !wodWord || !wodPos) return;
  if (!dictionaryBI.length) return;

  // Word of the day comes from the Bikol -> English database
  const picked = pickWordOfDay(dictionaryBI);
  if (!picked) return;

  currentWod = picked;

  const word = picked.bikol || "";
  const pos = picked.pos || "";
  const gloss = picked.sense1_gloss || "";
  const meaning = picked.sense1_meaning || "";

  // date
  if (wodDate) wodDate.textContent = formatWodDate(Date.now());

  // clickable word
  wodWord.innerHTML = '<a href="#" class="wod-link" id="wodLink">' + escapeHtml(word) + '</a>';
  wodPos.textContent = pos ? pos : "";

  // capsule label
  if (wodList) wodList.textContent = "Bikol Word of the Day";

  // optional level
  const lvl = (picked.level || picked.cefr || "");
  if (wodLevel) {
    if (String(lvl).trim()) {
      wodLevel.style.display = "inline-block";
      wodLevel.textContent = String(lvl).trim();
    } else {
      wodLevel.style.display = "none";
    }
  }

  // meaning text (used for display)
  if (wodMeaning) {
    let line = "";
    if (gloss) line += gloss;
    if (meaning) line += (line ? " — " : "") + meaning;
    wodMeaning.textContent = line || "";
  }

  // Listen button: enabled ONLY when an audio URL exists (no speechSynthesis)
  const audioUrl = (picked.audio_url || picked.audioUrl || picked.audio || "").toString().trim();
  if (wodListenBtn) {
    if (audioUrl) {
      wodAudio = new Audio(audioUrl);
      wodListenBtn.classList.remove("audio-unavailable");
      wodListenBtn.setAttribute("aria-label", "Listen");
    } else {
      wodAudio = null;
      wodListenBtn.classList.add("audio-unavailable");
      wodListenBtn.setAttribute("aria-label", "Audio unavailable");
    }
  }

  const wodLink = document.getElementById("wodLink");
  wodLink.addEventListener("click", (e) => {
    e.preventDefault();
    // Navigate to a shareable URL for this entry
    const term = (picked.bikol || "").trim();
    if (!term) return;
    setHashRoute("bikol", term, false);
    applyRouteFromHash();
  });
}

function setTrivia(){
  if (!triviaCard || !triviaTitle || !triviaText) return;
  if (!isHomeView()) {
    hideTrivia();
    return;
  }
  const baseItems = (Array.isArray(triviaItems) && triviaItems.length) ? triviaItems : fallbackTrivia;
  const featured = baseItems.filter(r => isTruthy(r.featured));
  const items = featured.length ? featured : baseItems;
  if (!items.length) {
    hideTrivia();
    return;
  }

  const weekIndex = Math.floor(Date.now() / (86400000 * 7));
  const item = items[weekIndex % items.length];
  if (!item) {
    hideTrivia();
    return;
  }

  triviaTitle.textContent = "DID YOU KNOW?";
  const rawText = (item.text || "").toString();
  triviaText.innerHTML = escapeHtml(rawText).replace(/\n\s*\n/g, "<br><br>");

  const imgRaw = (item.image || "").toString().trim();
  const imgToken = imgRaw.toLowerCase();
  const hasImage = imgRaw && !["-", "none", "null", "n/a", "na"].includes(imgToken);
  if (hasImage) {
    triviaPhoto.src = imgRaw;
    triviaPhoto.style.display = "";
    triviaPhoto.alt = "Trivia photo";
  } else {
    triviaPhoto.removeAttribute("src");
    triviaPhoto.style.display = "none";
  }

  showTrivia();
  applyTriviaClamp();
}

function parseDateAdded(row){
  const raw = (row.date_added || row.dateAdded || "").toString().trim();
  if (!raw) return 0;
  const t = Date.parse(raw);
  return Number.isNaN(t) ? 0 : t;
}

function timeAgoLabel(ts){
  if (!ts) return "Just now";
  const diff = Math.max(0, Date.now() - ts);
  const minute = 60000;
  const hour = 60 * minute;
  const day = 24 * hour;
  const week = 7 * day;
  const month = 30 * day;
  const year = 365 * day;

  if (diff < minute) return "Just now";
  if (diff < hour) {
    const m = Math.max(1, Math.floor(diff / minute));
    return m === 1 ? "a minute ago" : m + " minutes ago";
  }
  if (diff < day) {
    const h = Math.floor(diff / hour);
    return h === 1 ? "an hour ago" : h + " hours ago";
  }
  if (diff < week) {
    const d = Math.floor(diff / day);
    return d === 1 ? "a day ago" : d + " days ago";
  }
  if (diff < month) {
    const w = Math.floor(diff / week);
    return w === 1 ? "a week ago" : w + " weeks ago";
  }
  if (diff < year) {
    const mo = Math.floor(diff / month);
    return mo === 1 ? "a month ago" : mo + " months ago";
  }
  const y = Math.floor(diff / year);
  return y === 1 ? "a year ago" : y + " years ago";
}

function renderRecentAdded(){
  if (!recentCard || !recentList) return;
  if (!isHomeView()) {
    hideRecent();
    return;
  }
  const rows = Array.isArray(dictionaryBI) ? dictionaryBI.slice() : [];
  if (!rows.length) {
    hideRecent();
    return;
  }
  rows.sort((a, b) => parseDateAdded(b) - parseDateAdded(a));
  const items = rows.slice(0, 4);
  const html = items.map(row => {
    const word = escapeHtml(row.bikol || "");
    const gloss = escapeHtml(row.sense1_gloss || row.sense1_meaning || "");
    const when = timeAgoLabel(parseDateAdded(row));
    return (
      '<div class="recent-item" data-term="' + escapeHtml(row.bikol || "") + '">' +
        '<div>' +
          '<div class="recent-word">' + word + '</div>' +
          (gloss ? '<div class="recent-gloss">' + gloss + '</div>' : '') +
        '</div>' +
        '<div class="recent-meta">' + escapeHtml(when) + '</div>' +
      '</div>'
    );
  }).join("");
  recentList.innerHTML = html;
  recentList.querySelectorAll(".recent-item").forEach(item => {
    item.addEventListener("click", () => {
      const term = item.getAttribute("data-term") || "";
      if (!term) return;
      setHashRoute("bikol", term, false);
      applyRouteFromHash();
    });
  });
  showRecent();
}

function applyTriviaClamp(){
  if (!triviaCard || !triviaText || !triviaToggle) return;
  triviaExpanded = false;
  triviaCard.classList.add("is-collapsed");
  triviaCard.classList.remove("is-expanded");
  triviaToggle.textContent = "See more...";
  triviaToggle.style.display = "none";
  requestAnimationFrame(() => {
    const overflow = triviaText.scrollHeight > (triviaText.clientHeight + 1);
    if (overflow) {
      triviaToggle.style.display = "inline-flex";
    } else {
      triviaCard.classList.remove("is-collapsed");
    }
  });
}

function expandTrivia(){
  if (!triviaCard || !triviaToggle) return;
  triviaExpanded = true;
  triviaCard.classList.remove("is-collapsed");
  triviaCard.classList.add("is-expanded");
  triviaToggle.textContent = "See less...";
  triviaToggle.style.display = "inline-flex";
}

function collapseTrivia(){
  if (!triviaCard || !triviaText || !triviaToggle) return;
  triviaExpanded = false;
  triviaCard.classList.remove("is-expanded");
  triviaCard.classList.add("is-collapsed");
  triviaToggle.textContent = "See more...";
  const overflow = triviaText.scrollHeight > (triviaText.clientHeight + 1);
  triviaToggle.style.display = overflow ? "inline-flex" : "none";
  if (!overflow) triviaCard.classList.remove("is-collapsed");
}

// Listen button behavior (plays provided audio URL only)
if (wodListenBtn){
  wodListenBtn.addEventListener("click", () => {
    if (!wodAudio) return;

    try {
      wodAudio.currentTime = 0;
      wodAudio.play();
    } catch {}
  });
}

if (triviaToggle){
  triviaToggle.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    if (triviaExpanded) {
      collapseTrivia();
    } else {
      expandTrivia();
    }
  });
}


function syncWordOfDayVisibility(){
  if (!wordOfDay && !triviaCard) return;
  if (isHomeView()) {
    showWodRow();
    showWordOfDay();
    setWordOfDay();
    setTrivia();
    renderRecentAdded();
  } else {
    hideWordOfDay();
    hideTrivia();
    hideRecent();
    hideWodRow();
  }
}

function buildExampleHTML(ex){
  if (!ex) return "";
  const parts = String(ex).split("||");
  const bik = parts[0] ? escapeHtml(parts[0]) : "";
  const eng = parts[1] ? escapeHtml(parts[1]) : "";
  let html = '<div class="example">' + bik;
  if (eng) html += '<br><em>' + eng + '</em>';
  html += '</div>';
  return html;
}

function csvEscape(value){
  const raw = String(value ?? "");
  if (raw.includes('"') || raw.includes(",") || raw.includes("\n")) {
    return '"' + raw.replace(/"/g, '""') + '"';
  }
  return raw;
}

// Turn Bikol equivalents into deep links (to the Bikol → English entry)
function linkifyBikolEquivalents(text){
  const raw = String(text || "").trim();
  if (!raw) return "";

  // Split on separators; also split on the word "or" (simple, space-based)
  const chunks = raw.split(/[,;/|]+/);
  const tokens = [];
  chunks.forEach(c => {
    const p = String(c || "");
    // Handle " or " in a basic way without regex backslashes
    const sub = p.split(" or ").flatMap(x => x.split(" OR "));
    sub.forEach(t => {
      const term = String(t || "").trim();
      if (term) tokens.push(term);
    });
  });

  return tokens.map(term => {
    const href = "#/bikol/" + encodeURIComponent(term);
    return '<a href="' + href + '" class="equiv-link" title="Open Bikol entry">' + escapeHtml(term) + '</a>';
  }).join(", ");
}

// Turn English glosses into deep links (to the English → Bikol entry)
function linkifyEnglishGloss(text){
  const raw = String(text || "").trim();
  if (!raw) return "";

  // Often a single headword; but allow basic multi-term separators.
  const chunks = raw.split(/[,;/|]+/);
  const tokens = [];
  chunks.forEach(c => {
    const term = String(c || "").trim();
    if (term) tokens.push(term);
  });

  return tokens.map(term => {
    const href = "#/english/" + encodeURIComponent(term);
    return '<a href="' + href + '" class="gloss-link" title="Open English entry">' + escapeHtml(term) + '</a>';
  }).join(", ");
}

function getDialect(d){
  return (d.dialect || "").toString().trim();
}

function dialectHTML(d){
  const v = getDialect(d);
  if (!v) return "";
  return '<div class="dialect"><span class="value">' + escapeHtml(v) + '</span></div>';
}


function splitDerivsInflections(d){
  const raw = (d.derivatives_inflections || d.derivatives || d.inflections || "").toString().trim();
  if (!raw) return { derivs: "", infl: "" };

  const derivMatch = raw.match(/(?:^|[;|])\s*(?:derivatives?|derivs?)\s*:\s*([^;|]+)/i);
  const inflMatch = raw.match(/(?:^|[;|])\s*(?:inflections?)\s*:\s*([^;|]+)/i);
  if (derivMatch || inflMatch) {
    return {
      derivs: derivMatch ? derivMatch[1].trim() : "",
      infl: inflMatch ? inflMatch[1].trim() : ""
    };
  }

  if (raw.includes("||")) {
    const parts = raw.split("||").map(p => p.trim()).filter(Boolean);
    return { derivs: parts[0] || "", infl: parts[1] || "" };
  }
  if (raw.includes("|")) {
    const parts = raw.split("|").map(p => p.trim()).filter(Boolean);
    return { derivs: parts[0] || "", infl: parts[1] || "" };
  }

  return { derivs: "", infl: raw };
}

function derivsHTML(label, value, className){
  const v = (value || "").toString().trim();
  if (!v) return "";
  return '<div class="' + className + '"><span class="label">' + label + ':</span> <span class="value">' + escapeHtml(v) + '</span></div>';
}


function dictForMode(){
  return (lang.value === "english") ? dictionaryEN : dictionaryBI;
}

function fieldForMode(){
  return (lang.value === "english") ? "english" : "bikol";
}

function findSimilarTerms(query, limit){
  const q = String(query || "").trim().toLowerCase();
  if (!q) return [];
  const dict = dictForMode();
  const field = fieldForMode();
  const items = dict
    .map(row => (row[field] || "").toString().trim())
    .filter(Boolean);

  const starts = [];
  const contains = [];

  items.forEach(term => {
    const t = term.toLowerCase();
    if (t === q) return;
    if (t.startsWith(q)) starts.push(term);
    else if (t.includes(q)) contains.push(term);
  });

  const combined = starts.concat(contains);
  const unique = Array.from(new Set(combined));
  return unique.slice(0, limit || 6);
}

function renderEnglish(d){
  // update URL
  if (d && d.english) {
    const k = buildRouteKey("english", d.english);
    if (k !== currentRouteKey) {
      currentRouteKey = k;
      setHashRoute("english", d.english, true);
    }
  }
  hideWordOfDay();
  hideWodRow();
  entries.classList.remove("centered");
  closeSuggestions();

  const senses = [];
  for (let i = 1; i <= 10; i++) {
    const m = d["sense" + i + "_meaning"] || "";
    const b = d["sense" + i + "_bikol"] || "";
    const ex = d["sense" + i + "_example"] || "";
    if (!m) continue;
    senses.push({ m, b, ex });
  }

  let sensesHtml = "";
  if (senses.length === 1) {
    const s = senses[0];
    sensesHtml += '<div class="sense-block">';
    sensesHtml += '<div class="definition">' + escapeHtml(s.m) + '</div>';
    if (s.b) sensesHtml += '<div class="definition equivalent">' + linkifyBikolEquivalents(s.b) + '</div>';
    sensesHtml += buildExampleHTML(s.ex);
    sensesHtml += '</div>';
  } else if (senses.length > 1) {
    senses.forEach((s, idx) => {
      sensesHtml += '<div class="sense-block">';
      sensesHtml += '<div class="definition"><strong>' + (idx + 1) + '.</strong> ' + escapeHtml(s.m) + '</div>';
      if (s.b) sensesHtml += '<div class="definition equivalent">' + linkifyBikolEquivalents(s.b) + '</div>';
      sensesHtml += buildExampleHTML(s.ex);
      sensesHtml += '</div>';
    });
  } else {
    sensesHtml = '<div class="definition">No senses available.</div>';
  }

  entries.innerHTML =
    '<div class="entry">' +
      '<div class="headword">' +
        '<h2>' + escapeHtml(d.english || "") + '</h2>' +
        '<span class="pos">' + escapeHtml(d.pos || "") + '</span>' +
      '</div>' +
      sensesHtml +
    '</div>';
  syncDividerVisibility();

  // attach audio handlers (Bikol headword pronunciation)
  entries.querySelectorAll('.pron-play').forEach(btn => {
    const src = btn.getAttribute('data-audio');
    if (!src) return;
    const audio = new Audio(src);
    btn.addEventListener('click', () => {
      try { audio.currentTime = 0; audio.play(); } catch(e){}
    });
  });
}


function renderBikol(d){
  // update URL
  if (d && d.bikol) {
    const k = buildRouteKey("bikol", d.bikol);
    if (k !== currentRouteKey) {
      currentRouteKey = k;
      setHashRoute("bikol", d.bikol, true);
    }
  }

  hideWordOfDay();
  hideWodRow();
  entries.classList.remove("centered");
  closeSuggestions();

  const senses = [];
  for (let i = 1; i <= 10; i++) {
    const g = d["sense" + i + "_gloss"] || "";
    const m = d["sense" + i + "_meaning"] || "";
    const ex = d["sense" + i + "_example"] || "";
    if (!g && !m && !ex) continue;
    senses.push({ g, m, ex });
  }

  let sensesHtml = "";
  if (senses.length === 1) {
    const s = senses[0];
    sensesHtml += '<div class="sense-block">';
    if (s.g) sensesHtml += '<div class="definition">' + linkifyEnglishGloss(s.g) + '</div>';
    if (s.m) sensesHtml += '<div class="definition">' + escapeHtml(s.m) + '</div>';
    sensesHtml += buildExampleHTML(s.ex);
    sensesHtml += '</div>';
  } else if (senses.length > 1) {
    senses.forEach((s, idx) => {
      sensesHtml += '<div class="sense-block">';
      sensesHtml += '<div class="definition"><strong>' + (idx + 1) + '.</strong> ' + linkifyEnglishGloss(s.g) + '</div>';
      if (s.m) sensesHtml += '<div class="definition">' + escapeHtml(s.m) + '</div>';
      sensesHtml += buildExampleHTML(s.ex);
      sensesHtml += '</div>';
    });
  } else {
    sensesHtml = '<div class="definition">No senses available.</div>';
  }

  // Pronunciation row (Bikol → English): ALWAYS show audio button
  let ipa = (d.ipa || d.pron || d.pronunciation || "").toString().trim().replace(/^\/+|\/+$/g, "");
  const audioUrl = (d.audio_url || d.audioUrl || d.audio || "").toString().trim();

  let pronHtml = '<div class="pron">';
  if (audioUrl) {
    pronHtml += '<button type="button" class="pron-play" aria-label="Listen" data-audio="' + escapeHtml(audioUrl) + '"><i class="fa-solid fa-volume-high"></i></button>';
  } else {
    pronHtml += '<button type="button" class="pron-play audio-unavailable" aria-label="Audio unavailable"><i class="fa-solid fa-volume-high"></i></button>';
  }
  if (ipa) {
    pronHtml += '<span class="ipa">/' + escapeHtml(ipa) + '/</span>';
  }
  pronHtml += '</div>';

  // TEMP preview-only sample for "kakan" when fields are blank
  let dialectBlock = dialectHTML(d);
  const split = splitDerivsInflections(d);
  let derivsBlock = derivsHTML("Derivatives", split.derivs, "derivs");
  let inflBlock = derivsHTML("Inflections", split.infl, "inflections");
  if ((d.bikol || "").toLowerCase() === "kakan" && !dialectBlock && !derivsBlock && !inflBlock) {
    dialectBlock = '<div class="dialect"><span class="value">Naga Bikol</span></div>';
    inflBlock = '<div class="inflections"><span class="label">Inflections:</span> <span class="value">kakan, nagkakan, magkakan</span></div>';
  }

  entries.innerHTML =
    '<div class="entry">' +
      '<div class="headword">' +
        '<h2>' + escapeHtml(d.bikol || "") + '</h2>' +
        '<span class="pos">' + escapeHtml(d.pos || "") + '</span>' +
      '</div>' +
      pronHtml +
      dialectBlock +
      derivsBlock +
      inflBlock +
      sensesHtml +
    '</div>';
  syncDividerVisibility();

  // attach audio handlers
  entries.querySelectorAll('.pron-play').forEach(btn => {
    const src = btn.getAttribute('data-audio');
    if (!src) return;
    const audio = new Audio(src);
    btn.addEventListener('click', () => {
      try { audio.currentTime = 0; audio.play(); } catch(e){}
    });
  });
}


function render(d){
  entries.classList.remove("centered");
  hideWodRow();
  syncDividerVisibility();
  if (lang.value === "english") return renderEnglish(d);
  return renderBikol(d);
}

function noMatch(term){
  hideWordOfDay();
  hideWodRow();
  const modeText = (lang.value === "english") ? "English - Bikol" : "Bikol - English";
  const safeTerm = escapeHtml(term || "");
  const similar = findSimilarTerms(term, 6);

  // center the message in the page
  entries.classList.add("centered");

  let suggHtml = "";
  if (similar.length) {
    const base = (lang.value === "english") ? "#/english/" : "#/bikol/";
    const list = similar.map(t => {
      const href = base + encodeURIComponent(t);
      return '<li><a href="' + href + '">' + escapeHtml(t) + '</a></li>';
    }).join("");
    suggHtml =
      '<div class="suggestions-title">Did you mean:</div>' +
      '<ul class="suggestions-list">' + list + '</ul>';
  }

  entries.innerHTML =
    '<div class="entry no-match">' +
      '<div class="definition">' +
        'No exact match found for "' + safeTerm + '" in ' + modeText + ' Dictionary' +
      '</div>' +
      suggHtml +
    '</div>';
  syncDividerVisibility();
}

function performSearch(){
  hideWordOfDay();
  hideWodRow();
  const original = (search.value || "").trim();
  const q = original.toLowerCase();
  if (!q) return;

  const dict = dictForMode();
  const field = fieldForMode();

  // exact match only (no prefix matching)
  const match = dict.find(row => (row[field] || "").toLowerCase() === q);

  if (match) {
    render(match);
  } else {
    noMatch(original);
  }
}

function updateSuggestions(){
  const q = search.value.toLowerCase().trim();
  entries.innerHTML = "";
  closeSuggestions();
  isUserTyping = q.length > 0;
  updateClearButton();
  syncDividerVisibility();

  // Word of the day only shows on Home (no search + no results)
  if (!q) {
    syncWordOfDayVisibility();
    syncDividerVisibility();
    return;
  }

  hideWordOfDay();
  hideWodRow();

  const dict = dictForMode();
  const field = fieldForMode();
  const matches = dict.filter(row => (row[field] || "").toLowerCase().startsWith(q));
  if (!matches.length) return;

  suggestions.classList.add("open");

  const side = document.createElement("div");
  side.className = "sugg-side";
  side.textContent = (lang.value === "english") ? "English to Bikol" : "Bikol to English";

  const list = document.createElement("div");
  list.className = "sugg-list";

  matches.slice(0, 12).forEach(row => {
    const item = document.createElement("div");
    item.className = "sugg-item";
    item.textContent = row[field];
    item.addEventListener("click", () => {
      hideWordOfDay();
      /* clear whatever the user typed, then render */
      search.value = "";
      updateClearButton();
      render(row);
    });
    list.appendChild(item);
  });

  suggestions.appendChild(side);
  suggestions.appendChild(list);
}

// NOTE: buildReverse removed. Bikol → English is now MANUAL only.
// Keep entries exclusively from bikol_to_english.csv.

function setDataFromFiles(enRows, biRows){
  dictionaryEN = (enRows || []).filter(row => row.english);

  // Bikol → English is MANUAL ONLY
  dictionaryBI = (Array.isArray(biRows) ? biRows : []).filter(r => (r.bikol || "").toString().trim());

  dataReady = true;

  // Ensure deep-links render after data loads
  currentRouteKey = "";
  applyRouteFromHash();

  // initial placeholder
  if (lang.value === "english") {
    search.placeholder = "Search English - Bikol Dictionary";
  } else {
    search.placeholder = "Search Bikol - English Dictionary";
  }

  syncWordOfDayVisibility();
  syncDividerVisibility();
  hideLoading();
  renderRecentAdded();
}

function showNotice(html){
  entries.innerHTML = '<div class="notice">' + html + '</div>';
  syncDividerVisibility();
  hideLoading();
  renderRecentAdded();
}

function loadCsvFromText(csvText){
  Papa.parse(csvText, {
    header:true,
    skipEmptyLines:true,
    complete:(r) => {
      setDataFromFiles(r.data || [], null);
    }
  });
}

function loadCsvFromTextPair(enText, biText){
  Papa.parse(enText, {
    header:true,
    skipEmptyLines:true,
    complete:(enRes) => {
      Papa.parse(biText, {
        header:true,
        skipEmptyLines:true,
        complete:(biRes) => {
          setDataFromFiles(enRes.data || [], biRes.data || []);
        }
      });
    }
  });
}

function loadCsvFromFile(){
  showLoading();
  const enUrl = "english_to_bikol.csv?" + Date.now();
  const biUrl = "bikol_to_english.csv?" + Date.now();
  const triviaUrl = "trivia.csv?" + Date.now();

  Papa.parse(enUrl, {
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:(enRes) => {
      // Try load separate Bikol→English; if it fails, we will derive from English→Bikol.
      Papa.parse(biUrl, {
        download:true,
        header:true,
        skipEmptyLines:true,
        complete:(biRes) => {
          setDataFromFiles(enRes.data || [], biRes.data || []);
        },
        error:() => {
          // No Bikol CSV = empty Bikol dictionary
          setDataFromFiles(enRes.data || [], []);
        }
      });
    },
    error:() => {
      // Sandbox preview fallback (both)
      const fallbackEN = document.getElementById("csv-fallback");
      const fallbackBI = document.getElementById("csv-fallback-bi");
      const enText = (fallbackEN && fallbackEN.textContent) ? fallbackEN.textContent : "";
      const biText = (fallbackBI && fallbackBI.textContent) ? fallbackBI.textContent : "";

      if (enText && biText) {
        loadCsvFromTextPair(enText, biText);
      } else {
        loadCsvFromText(enText || "");
      }

      showNotice(
        '<strong>CSV not loaded.</strong> This preview cannot fetch CSV files.<br>' +
        'On GitHub Pages, keep <code>english_to_bikol.csv</code> (required) and <code>bikol_to_english.csv</code> (optional) beside this HTML.'
      );
    }
  });

  Papa.parse(triviaUrl, {
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:(res) => {
      triviaItems = (res.data || []).filter(r => (r.text || r.image || r.featured));
      setTrivia();
    },
    error:() => {
      triviaItems = [];
      setTrivia();
    }
  });
}

// Home link behavior
const homeLink = document.getElementById("homeLink");
homeLink.addEventListener("click", (e) => {
  e.preventDefault();
  clearHashRoute();
  search.value = "";
  isUserTyping = false;
  entries.innerHTML = "";
  closeSuggestions();
  syncWordOfDayVisibility();
  updateClearButton();
  syncDividerVisibility();
  currentRouteKey = "";
  window.scrollTo({ top: 0, behavior: "smooth" });
});

// Events
search.addEventListener("input", updateSuggestions);
search.addEventListener("keydown", (e) => {
  if (e.key === "Enter") performSearch();
});
searchBtn.addEventListener("click", performSearch);
if (clearBtn){
  clearBtn.addEventListener("click", () => {
    search.value = "";
    isUserTyping = false;
    entries.innerHTML = "";
    closeSuggestions();
    updateClearButton();
    syncWordOfDayVisibility();
    syncDividerVisibility();
    search.focus();
  });
}

// Show long labels only while dropdown is open
function setLangOptionsLong(){
  Array.from(lang.options).forEach(opt => {
    if (opt.dataset.long) opt.textContent = opt.dataset.long;
  });
}
function setLangOptionsShort(){
  Array.from(lang.options).forEach(opt => {
    if (opt.dataset.short) opt.textContent = opt.dataset.short;
  });
}

lang.addEventListener("mousedown", setLangOptionsLong);
lang.addEventListener("focus", setLangOptionsLong);
lang.addEventListener("blur", setLangOptionsShort);

lang.addEventListener("change", () => {
  // update placeholder based on language
  if (lang.value === "english") {
    search.placeholder = "Search English - Bikol Dictionary";
  } else {
    search.placeholder = "Search Bikol - English Dictionary";
  }
  setLangOptionsShort();
  closeSuggestions();
  entries.innerHTML = "";
  search.value = "";
  syncWordOfDayVisibility();
  updateClearButton();
  syncDividerVisibility();
  search.focus();
});

burger.addEventListener("click", () => {
  const isOpen = menu.classList.toggle("open");
  burger.setAttribute("aria-expanded", isOpen ? "true" : "false");
  if (isOpen) positionMenu();
});

window.addEventListener("resize", () => {
  if (menu && menu.classList.contains("open")) {
    positionMenu();
  }
});

document.addEventListener("click", (e) => {
  if
(!e.target.closest(".search-wrapper")) closeSuggestions();

  if (
    menu.classList.contains("open") &&
    !e.target.closest("#menu") &&
    !e.target.closest("#burger")
  ) {
    menu.classList.remove("open");
    burger.setAttribute("aria-expanded", "false");
  }

  if (triviaExpanded && !e.target.closest("#triviaCard")) {
    collapseTrivia();
  }
});

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    closeSuggestions();
    if (menu.classList.contains("open")) {
      menu.classList.remove("open");
      burger.setAttribute("aria-expanded", "false");
    }
    closeSubmitModal();
    closeContactModal();
    closeDonateModal();
  }
});

window.addEventListener("hashchange", () => {
  applyRouteFromHash();
});

if (submitBtn){
  submitBtn.addEventListener("click", () => {
    openSubmitModal();
  });
}
if (subPos){
  subPos.addEventListener("change", () => {
    const isOther = (subPos.value || "").toLowerCase() === "others";
    if (subPosOtherWrap && subPosOther) {
      subPosOtherWrap.style.display = isOther ? "" : "none";
      subPosOther.required = isOther;
      if (!isOther) subPosOther.value = "";
    }
  });
}
if (submitClose){
  submitClose.addEventListener("click", closeSubmitModal);
}
if (submitCancel){
  submitCancel.addEventListener("click", closeSubmitModal);
}
if (submitModal){
  submitModal.addEventListener("click", (e) => {
    if (e.target === submitModal) closeSubmitModal();
  });
}

if (submitForm){
  submitForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const data = new FormData(submitForm);
    const word = (data.get("word") || "").toString().trim();
    const pos = (data.get("pos") || "").toString().trim();
    const posOther = (data.get("pos_other") || "").toString().trim();
    const meaning = (data.get("meaning") || "").toString().trim();
    const example = (data.get("example") || "").toString().trim();
    const dialect = (data.get("dialect") || "").toString().trim();
    const derivatives = (data.get("derivatives") || "").toString().trim();
    const inflections = (data.get("inflections") || "").toString().trim();
    const name = (data.get("name") || "").toString().trim();
    const submittedAt = new Date().toISOString();

    const subject = "Bikol Dictionary Submission: " + (word || "New entry");
    const lines = [
      "Bikol Word: " + word,
      "Part of Speech: " + (posOther ? (pos + " (" + posOther + ")") : pos),
      "Meaning(s): " + meaning,
      "Example: " + example,
      "Dialect: " + dialect,
      "Derivatives: " + derivatives,
      "Inflections: " + inflections,
      "Contributor Name: " + name,
      "Submitted At: " + submittedAt
    ];
    const body = lines.join("\n");
    const mailto = "mailto:jusanmisolas@gmail.com" +
      "?subject=" + encodeURIComponent(subject) +
      "&body=" + encodeURIComponent(body);

    const csvHeader = [
      "submitted_at",
      "bikol_word",
      "part_of_speech",
      "meaning",
      "example_sentences",
      "dialect_language",
      "derivatives",
      "inflections",
      "contributor_name"
    ];
    const csvRow = [
      submittedAt,
      word,
      pos,
      meaning,
      example,
      dialect,
      derivatives,
      inflections,
      name
    ].map(csvEscape).join(",");
    const csvContent = csvHeader.join(",") + "\n" + csvRow + "\n";
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "submissions.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    window.location.href = mailto;
    closeSubmitModal();
  });
}

if (contactLink){
  contactLink.addEventListener("click", (e) => {
    e.preventDefault();
    openContactModal();
  });
}
if (contactClose){
  contactClose.addEventListener("click", closeContactModal);
}
if (contactCancel){
  contactCancel.addEventListener("click", closeContactModal);
}
if (contactModal){
  contactModal.addEventListener("click", (e) => {
    if (e.target === contactModal) closeContactModal();
  });
}
if (contactForm){
  contactForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const data = new FormData(contactForm);
    const name = (data.get("name") || "").toString().trim();
    const email = (data.get("email") || "").toString().trim();
    const subject = (data.get("subject") || "").toString().trim();
    const message = (data.get("message") || "").toString().trim();

    const body = [
      "From: " + name,
      "Email: " + email,
      "",
      message
    ].join("\n");

    const mailto = "mailto:jusanmisolas@gmail.com" +
      "?subject=" + encodeURIComponent(subject || "Bikol Dictionary contact") +
      "&body=" + encodeURIComponent(body);

    window.location.href = mailto;
    closeContactModal();
  });
}

if (donateLink){
  donateLink.addEventListener("click", (e) => {
    e.preventDefault();
    openDonateModal();
  });
}
if (donateBtn){
  donateBtn.addEventListener("click", () => {
    openDonateModal();
  });
}
if (donateClose){
  donateClose.addEventListener("click", closeDonateModal);
}
if (donateModal){
  donateModal.addEventListener("click", (e) => {
    if (e.target === donateModal) closeDonateModal();
  });
}
if (donateOptions.length){
  donateOptions.forEach(btn => {
    btn.addEventListener("click", () => {
      setDonateMethod(btn.dataset.method);
    });
  });
}

// Load CSV files
loadCsvFromFile();

// Initial routing + Word of the Day
applyRouteFromHash();
syncWordOfDayVisibility();
updateClearButton();
syncDividerVisibility();

// Smoke tests (optional)
function assert(condition, message){
  if (!condition) throw new Error(message);
}

(function runTests(){
  try {
    assert(document.getElementById("lang"), "Lang select should exist");
    assert(document.getElementById("search"), "Search input should exist");
    assert(document.getElementById("suggestions"), "Suggestions container should exist");
    assert(document.getElementById("wordOfDay"), "Word of Day block should exist");
    console.log("Smoke tests passed");
  } catch (e) {
    console.error("Smoke tests failed:", e);
  }
})();
</script>
</body>
</html>
